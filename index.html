<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2305数学宝可梦大冒险</title>
    <!-- React 核心 -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- 依赖库 -->
    <script src="https://unpkg.com/prop-types/prop-types.min.js"></script>
    <!-- 样式库 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <!-- 图表库 Recharts -->
    <script src="https://unpkg.com/recharts@2.12.0/umd/Recharts.min.js"></script> 
    <!-- 字体 -->
    <link href="https://fonts.googleapis.com/css2?family=ZCOOL+KuaiLe&family=Fredoka:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-color: #f0f9ff;
            --card-bg: rgba(255, 255, 255, 0.95);
        }

        body { 
            background-color: var(--bg-color);
            background-image: 
                radial-gradient(#bae6fd 15%, transparent 16%),
                radial-gradient(#bae6fd 15%, transparent 16%);
            background-size: 30px 30px;
            background-position: 0 0, 15px 15px;
            font-family: "ZCOOL KuaiLe", "Fredoka", system-ui, sans-serif; 
            color: #1e3a8a;
            -webkit-font-smoothing: antialiased;
            overflow-x: hidden;
            user-select: none;
        }

        /* --- UI 组件 --- */
        .glass-card {
            background: var(--card-bg);
            backdrop-filter: blur(16px);
            border-radius: 1.5rem;
            border: 4px solid #ffffff;
            box-shadow: 
                0 10px 15px -3px rgba(0, 0, 0, 0.1),
                0 4px 6px -2px rgba(0, 0, 0, 0.05),
                inset 0 0 0 2px rgba(255, 255, 255, 0.5);
            transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        
        .game-btn {
            position: relative;
            border: none;
            transition: all 0.1s;
            transform: translateY(0);
            box-shadow: 0 5px 0 rgba(0,0,0,0.2);
            text-shadow: 0 2px 0 rgba(0,0,0,0.1);
        }
        .game-btn:active {
            transform: translateY(5px);
            box-shadow: 0 0 0 rgba(0,0,0,0.2);
        }
        .game-btn:disabled {
            box-shadow: none;
            transform: translateY(2px);
            filter: grayscale(1);
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* --- 动画类 --- */
        .pokemon-sprite {
    /* image-rendering: pixelated;  <-- 删掉这一行，或者像这样注释掉 */
    filter: drop-shadow(0 8px 8px rgba(0,0,0,0.3)); /* 加深阴影，增加3D浮空感 */
    transition: all 0.3s;
    transform: scale(1.1); /* 3D素材通常稍微小一点，放大一点点视觉效果更好 */
}

        .bounce-custom { animation: bounceCustom 2s infinite; }
        @keyframes bounceCustom {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-15px); }
        }

        .attack-anim { animation: attackRight 0.4s ease-in-out; }
        @keyframes attackRight {
            0% { transform: translateX(0) scale(1); }
            50% { transform: translateX(80px) scale(1.2); }
            100% { transform: translateX(0) scale(1); }
        }

        .hit-anim { animation: hitShake 0.4s ease-in-out; filter: brightness(2) sepia(1) hue-rotate(-50deg) saturate(5); }
        @keyframes hitShake {
            0% { transform: translateX(0); }
            25% { transform: translateX(-15px) rotate(-5deg); }
            75% { transform: translateX(15px) rotate(5deg); }
            100% { transform: translateX(0); }
        }

        .coin-transform { animation: coinSpin 0.8s ease-in-out forwards; }
        @keyframes coinSpin {
            0% { transform: scale(1) rotate(0); opacity: 1; filter: none; }
            50% { transform: scale(0.1) rotate(360deg); opacity: 0.5; }
            100% { transform: scale(1.5) rotate(720deg); opacity: 0; }
        }
        
        .coin-appear { animation: coinPop 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        @keyframes coinPop {
            0% { transform: scale(0) translateY(50px); opacity: 0; }
            100% { transform: scale(1) translateY(0); opacity: 1; }
        }

        .levelup-enter { animation: levelUpPop 0.8s cubic-bezier(0.68, -0.55, 0.27, 1.55) forwards; }
        @keyframes levelUpPop { from { transform: scale(0) rotate(-180deg); opacity: 0; } to { transform: scale(1) rotate(0); opacity: 1; } }

        .modal-enter { animation: modalPop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        @keyframes modalPop { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        
        .wrong-tag {
            position: absolute; top: -5px; right: -5px;
            background: #ef4444; color: white;
            border-radius: 50%; width: 20px; height: 20px;
            display: flex; items-center; justify-center;
            font-size: 10px; font-weight: bold;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            animation: pulse 2s infinite;
        }
        
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        
        .boss-glow { box-shadow: 0 0 20px rgba(253, 224, 71, 0.6), inset 0 0 20px rgba(253, 224, 71, 0.2); border-color: #facc15; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;
        
        // 安全引入 Recharts
        const RechartsObj = window.Recharts || {
            BarChart: () => null, Bar: () => null, XAxis: () => null, YAxis: () => null, 
            CartesianGrid: () => null, Tooltip: () => null, ResponsiveContainer: ({children}) => <div>{children}</div>, 
            PieChart: () => null, Pie: () => null, Cell: () => null
        };
        const { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, PieChart, Pie, Cell } = RechartsObj;

        // --- 0. 资源与配置 (使用更稳定的资源源，或者Base64占位符) ---
        // 为了演示稳定性，这里使用 gitmirror 镜像，如果失败则回退到官方 Art
        const POKE_URL = "https://raw.gitmirror.com/PokeAPI/sprites/master/sprites/pokemon/other/showdown/";
        const POKE_ART_URL = "https://raw.gitmirror.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/";
        
        const STARTERS = [
            25, 1, 4, 7, 133, 152, 155, 158, 390, 393,
            94, 143, 448, 700, 658, 150, 282, 132, 54, 129
        ]; 

        const ENEMIES = {
            'M1': [16, 17, 18, 163, 164, 333],
            'M2': [74, 75, 76, 95, 208],
            'M3': [59, 143, 248, 304],
            'M4': [63, 64, 65, 150, 151],
            'M5': [132, 448, 447],
            'M6': [81, 82, 462, 100, 101],
            'M7': [137, 233, 474, 374],
           'M8': [35, 36, 175, 176, 39],
           'M9': [633, 634, 635], // <--- 新增这一行 (单首龙、双头龙、三首恶龙)
           'BOSS': [150, 249, 384, 483, 484, 493]
        };

const UNIT_NAMES = {
    'M1': '时、分、秒',
    'M2': '万以内的加法和减法(一)',
    'M3': '测量',
    'M4': '万以内的加法和减法(二)',
    'M5': '倍的认识',
    'M6': '多位数乘一位数',
    'M7': '数字编码',  // <--- 补上这一行
    'M8': '分数的初步认识',
    'M9': '数学广角：集合',
    'BOSS': '期末大挑战'
};        
const RANKS = [
            { name: '新手', icon: '🥚', minExp: 0, color: 'bg-gray-100 text-gray-500' },
            { name: '青铜', icon: '🥉', minExp: 200, color: 'bg-orange-100 text-orange-700' },
            { name: '白银', icon: '🥈', minExp: 600, color: 'bg-slate-100 text-slate-500' },
            { name: '黄金', icon: '🥇', minExp: 1200, color: 'bg-yellow-100 text-yellow-600' },
            { name: '钻石', icon: '💎', minExp: 2000, color: 'bg-purple-100 text-purple-600' },
            { name: '大师', icon: '👑', minExp: 3500, color: 'bg-red-100 text-red-600' },
            { name: '宗师', icon: '🌟', minExp: 6000, color: 'bg-indigo-100 text-indigo-600' },
            { name: '王者', icon: '🐲', minExp: 10000, color: 'bg-red-200 text-red-800' }
        ];

        // --- 2. 商品列表 (含实物与盲盒) ---
        const SHOP_ITEMS = [
            { id: 'item1', name: '哞哞鲜奶', price: 50, icon: '🥛', desc: '恢复 30 点体力 (涨价啦)' },
            { id: 'item2', name: '经验糖果', price: 100, icon: '🍬', desc: '增加 50 经验' },
            { id: 'item3', name: '小鼻嘎', price: 1500, icon: '🐻‍❄️', desc: '白色可爱小鼻嘎' },
            { id: 'item4', name: '捏捏乐', price: 2500, icon: '🦊', desc: '实物奖励' },
            // 盲盒
            { id: 'box_normal', name: '普通盲盒', price: 200, icon: '📦', desc: '随机奖励 (低保底)' },
            { id: 'box_high', name: '高级盲盒', price: 1000, icon: '🎁', desc: '必得好物，概率出实物券' },
            // 虚拟玩具
            { id: 'item2', name: '猫猫挂件', price: 800, icon: '🐱', desc: '放在背包里很可爱' },
            // 实物大奖 (S1赛季目标)
            { id: 'real1', name: '免做卡(一张)', price: 5000, icon: '🎫', desc: '老师亲笔签名，免一次作业' },
            { id: 'real2', name: '蛋仔挂件', price: 4000, icon: '🐣', desc: '实物奖励，找老师兑换' },
            { id: 'real3', name: '神秘大礼包', price: 15000, icon: '🎒', desc: '神秘礼包全班仅3份' },
        ];
        
       // --- 新增：宠物数据库 (100只宝可梦) ---
      // 扩充至 200 只宠物
        const PET_DB = Array.from({length: 200}, (_, i) => ({ id: i + 1, name: `No.${i + 1} 精灵` }));

        // --- 1. 题库配置 (STATIC_DB) ---
        const STATIC_DB = {
            'M1': { 
                BASIC: [
                    {t:"秒针走一圈的时间是( )？", type:"MC", o:["1秒","1分","1时"], a:"1分"},
                    {t:"1分20秒 = ( )秒", type:"INPUT", a:"80"},
                    {t:"钟表滴答一声大约是1( )", type:"MC", o:["时","分","秒"], a:"秒"},
                    {t:"3时 = ( )分", type:"INPUT", a:"180"},
                    {t:"时针走一大格，分针走( )圈", type:"INPUT", a:"1"},
                    {t:"120秒 = ( )分", type:"INPUT", a:"2"}, 
                    {t:"分针走半圈是( )分", type:"INPUT", a:"30"},
                    {t:"小明跑50米用了9( )", type:"MC", o:["时","分","秒"], a:"秒"},
                    {t:"一场电影大约播放2( )", type:"MC", o:["时","分","秒"], a:"时"},
                ],
                APP: [
                    {t:"跑60米，小红14秒，小英12秒，小云13秒，谁跑得快？(填名字)", type:"INPUT", a:"小英", e:"用时越少越快"},
                    {t:"一场足球赛90分钟，16:30结束，开始时间是？(格式如 15:00)", type:"INPUT", a:"15:00"},
                    {t:"11:40到12:05经过了( )分钟", type:"INPUT", a:"25"},
                    {t:"100米游泳，小林2分28秒，小玲3分5秒，小林比小玲快( )秒", type:"INPUT", a:"37", e:"185秒-148秒"},
                    {t:"上午8:00开始上课，一节课40分钟，下课时间是？(格式如 8:40)", type:"INPUT", a:"8:40"},
                    {t:"电影9:30播放，时长1小时30分，结束时间是？(格式如 11:00)", type:"INPUT", a:"11:00"},
                    {t:"李阿姨早餐店6:30开门，10:00关门，营业时间是( )小时30分", type:"INPUT", a:"3"},
                    {t:"文艺演出9:30开始，提前15分钟是( )开始", type:"INPUT", a:"9:15", e:"9时30分 - 15分 = 9时15分"},
                    {t:"小明7:15上学，路上用25分钟，他( )到校", type:"INPUT", a:"7:40", e:"7:15 + 25分 = 7:40"},
                ]
            },
            'M2': {
                BASIC: [
                    {t:"42厘米+58厘米 = ( )米", type:"INPUT", a:"1"},
                    {t:"66比32多多少？", type:"INPUT", a:"34"},
                    {t:"899减去301的差大约是？", type:"INPUT", a:"600"},
                    {t:"54+38=( )", type:"INPUT", a:"92"},
                    {t:"最大的两位数与最小的两位数的差是( )", type:"INPUT", a:"89"},
                    {t:"72 - 35 = ( )", type:"INPUT", a:"37"},
                    {t:"28 + 56 = ( )", type:"INPUT", a:"84"},
                    {t:"90 - 45 = ( )", type:"INPUT", a:"45"},
                ],
                APP: [
                    {t:"面粉厂有960袋，运走180和250袋，现在比原来少多少？", type:"INPUT", a:"430", e:"运走了多少就是少了多少：180+250"},
                    {t:"妈妈有500元，买210元和180元的东西，钱够吗？(填够或不够)", type:"INPUT", a:"够", e:"210+180=390, 390<500"},
                    {t:"一件上衣180元，一条裤子120元，一共多少元？", type:"INPUT", a:"300"},
                    {t:"一本故事书120页，看了40页，还剩多少页？", type:"INPUT", a:"80"},
                    {t:"果园有苹果树200棵，梨树150棵，一共多少棵？", type:"INPUT", a:"350"},
                    {t:"芸芸和芳芳各有36张邮票，芸芸送给芳芳11张后，芸芸比芳芳少( )张", type:"INPUT", a:"22", e:"相差2个11"},
                    {t:"学校买图书，编号630到780，共有多少本？", type:"INPUT", a:"151", e:"780-630+1"},
                    {t:"一根铁丝100米，用去27米和38米，短了( )米", type:"INPUT", a:"65", e:"用去多少就是短了多少"},
                ]
            },
            'M3': {
                BASIC: [
                    {t:"右手一'拃'的长度大约是20( )", type:"MC", o:["毫米","厘米","分米"], a:"厘米"},
                    {t:"1千米=1000米，对吗？", type:"MC", o:["对","错"], a:"对"},
                    {t:"一头大象重约4( )", type:"MC", o:["克","千克","吨"], a:"吨"},
                    {t:"4米 = ( )厘米", type:"INPUT", a:"400"},
                    {t:"3000千克=( )吨", type:"INPUT", a:"3"},
                    {t:"1分米 = ( )厘米", type:"INPUT", a:"10"},
                    {t:"80毫米 = ( )厘米", type:"INPUT", a:"8"},
                    {t:"身份证厚度大约1( )", type:"MC", o:["毫米","厘米"], a:"毫米"},
                ],
                APP: [
                    {t:"把2米长的绳子平均分成4段，每段长( )分米", type:"INPUT", a:"5", e:"2米=20分米, 20÷4=5"},
                    {t:"3千米 - 1000米 = ( )千米", type:"INPUT", a:"2", e:"1000米=1千米, 3-1=2"},
                    {t:"跑道一圈400米，两圈半是( )米", type:"INPUT", a:"1000", e:"400+400+200"},
                    {t:"一支铅笔用去20毫米，还剩14厘米，原来长( )厘米", type:"INPUT", a:"16", e:"20毫米=2厘米, 14+2=16"},
                    {t:"大车运3吨，小车运2吨，运14吨怎么运次数最少？(填大4小1或大2小4)", type:"INPUT", a:"大4小1", e:"多用大车"},
                    {t:"把6厘米的铁丝剪掉3厘米，再减去3毫米，还剩( )毫米", type:"INPUT", a:"27", e:"60-30-3=27"},
                    {t:"5块厚8毫米的橡皮叠起来是( )厘米", type:"INPUT", a:"4", e:"8x5=40毫米=4厘米"},
                ]
            },
            'M4': {
                BASIC: [
                    {t:"三位数加三位数，和可能是( )位数", type:"MC", o:["三","四","三或四"], a:"三或四"},
                    {t:"279 + 752 = ?", type:"INPUT", a:"1031"},
                    {t:"最大的三位数与最小的四位数的和是？", type:"INPUT", a:"1999"},
                    {t:"验算减法的方法是：差 + ( ) = 被减数", type:"MC", o:["加数","减数"], a:"减数"},
                    {t:"503 - 198 的差大约是( )", type:"INPUT", a:"300"},
                    {t:"405 - 298 = ( )", type:"INPUT", a:"107"},
                ],
                APP: [
                    {t:"一台家教机原价620，现价479，便宜了多少？", type:"INPUT", a:"141"},
                    {t:"植物园上午接待206人，下午比上午多99人，全天接待多少人？", type:"INPUT", a:"511", e:"206 + (206+99)"},
                    {t:"工程队上午装302米，下午装198米，上午比下午多装多少？", type:"INPUT", a:"104"},
                    {t:"剧场楼下525座，比楼上多156座，剧场一共有多少座？", type:"INPUT", a:"894", e:"525 + (525-156)"},
                    {t:"2月用水582吨，3月413吨，相差多少？", type:"INPUT", a:"169"},
                    {t:"5月比3月多用72吨，3月用413吨，5月用( )吨", type:"INPUT", a:"485"},
                ]
            },
            'M5': {
                BASIC: [
                    {t:"8的9倍是多少？", type:"INPUT", a:"72"},
                    {t:"求6的2倍是多少，列式为？", type:"MC", o:["6÷2","6×2"], a:"6×2"},
                    {t:"36里面有( )个9", type:"INPUT", a:"4"},
                    {t:"5的6倍是( )", type:"INPUT", a:"30"},
                    {t:"( )的4倍是28", type:"INPUT", a:"7"},
                    {t:"24是3的( )倍", type:"INPUT", a:"8"},
                ],
                APP: [
                    {t:"今年妈妈35岁，小华5岁，妈妈是小华的几倍？", type:"INPUT", a:"7"},
                    {t:"5年后，妈妈年龄还是小华的7倍吗？(填是或否)", type:"INPUT", a:"否", e:"倍数改变，差不变"},
                    {t:"红花60朵，蓝花8朵。红花是蓝花8倍，蓝花不变，红花加( )朵", type:"INPUT", a:"4", e:"8x8=64, 60+4=64"},
                    {t:"小羊8只，小牛的只数是小羊的3倍，小牛有( )只", type:"INPUT", a:"24"},
                    {t:"爸爸今年36岁，是儿子年龄的6倍，儿子今年( )岁", type:"INPUT", a:"6"},
                    {t:"一支笔2元，买8支需要( )元", type:"INPUT", a:"16"},
                    {t:"小刚看书48页，小明8页，小刚是小明的( )倍", type:"INPUT", a:"6"},
                ]
            },
            'M6': {
                BASIC: [
                    {t:"0 x 36 = ?", type:"INPUT", a:"0"},
                    {t:"305 x 4 的积末尾有几个0？", type:"INPUT", a:"1", e:"1220，末尾1个0"},
                    {t:"500 x 4 的积末尾有几个0？", type:"INPUT", a:"3", e:"2000，末尾3个0"},
                    {t:"200 x 5 = ?", type:"INPUT", a:"1000"},
                    {t:"任何数和0相乘都得( )", type:"INPUT", a:"0"},
                    {t:"125 x 8 = ?", type:"INPUT", a:"1000"},
                ],
                APP: [
                    {t:"一套书68元，买5套大约要( )元", type:"INPUT", a:"350", e:"70x5=350"},
                    {t:"一辆车运80箱，4辆车运( )箱", type:"INPUT", a:"320"},
                    {t:"游泳池长50米，游一个来回是( )米", type:"INPUT", a:"100"},
                    {t:"自行车396元，每月攒140，需要攒( )个月", type:"INPUT", a:"3", e:"140x3=420 > 396"},
                    {t:"买了2台电视每台950，又买3台风扇450元，一共( )元", type:"INPUT", a:"2350", e:"950x2+450"},
                    {t:"每排柳树62棵，有4排，大约( )棵", type:"INPUT", a:"240", e:"60x4=240"},
                    {t:"一桶油重158，用去一半还剩88，桶重( )", type:"INPUT", a:"18", e:"油重=(158-88)x2=140, 158-140=18"},
                ]
            },
            'M7': {
                BASIC: [
                    {t:"身份证倒数第二位是奇数，表示性别是？", type:"MC", o:["男","女"], a:"男"},
                    {t:"邮政编码由几位数字组成？", type:"INPUT", a:"6"},
                    {t:"110是( )电话", type:"MC", o:["报警","火警"], a:"报警"},
                    {t:"身份证号码一共有( )位", type:"INPUT", a:"18"},
                    {t:"火警电话是( )", type:"INPUT", a:"119"},
                ],
                APP: [
                    {t:"360622196806140011的出生年份是( )", type:"INPUT", a:"1968"},
                    {t:"某学生编号201801051，表示2018年入学1班5号男生。那201902102是( )生", type:"INPUT", a:"女"},
                    {t:"小光是2003102361(1年2班36号男生)，同班27号女生编号是？", type:"INPUT", a:"2003102272", e:"末位变2, 学号变27"},
                    {t:"李小林身份证...20051207...，他是( )孩", type:"MC", o:["男","女"], a:"不确定", e:"要看倒数第二位"},
                ]
            },
            'M8': {
                BASIC: [
                    {t:"把一个苹果平均分成2份，每份是？", type:"MC", o:["1/2","2"], a:"1/2"},
                    {t:"1 - 3/5 = ?", type:"MC", o:["2/5","5/5"], a:"2/5"},
                    {t:"分子相同，分母大的分数反而？", type:"MC", o:["大","小"], a:"小"},
                    {t:"5个1/8是( )", type:"MC", o:["5/8","1/8"], a:"5/8"},
                    {t:"1可以看作( )/4", type:"INPUT", a:"4"},
                    {t:"3个1/5是( )", type:"MC", o:["3/5","1/5"], a:"3/5"},
                ],
                APP: [
                    {t:"把一块饼平均分成4份，吃了1份，吃了这块饼的( )", type:"MC", o:["1/4","3/4"], a:"1/4"},
                    {t:"一瓶果汁喝了3/5，还剩( )/5", type:"INPUT", a:"2"},
                    {t:"猫妈妈钓12条鱼，小猫吃1/3，吃了几条？", type:"INPUT", a:"4", e:"12除以3"},
                    {t:"有15块饼干，小明吃1/3，吃了几块？", type:"INPUT", a:"5"},
                    {t:"一块巧克力，小红吃了1/2，小明吃了1/2，还剩( )", type:"INPUT", a:"0"},
                    {t:"一段绳子剪去1/5，还剩( )/5", type:"INPUT", a:"4"},
                    {t:"妈妈吃1/2，小亮吃1/2，两人一共吃( )", type:"INPUT", a:"1"},
                ]
            },
            'BOSS': {
                APP: [
                    {t:"【植树问题】路长20米，每5米种一棵(两端都种)，共种几棵？", type:"INPUT", a:"5", e:"段数=4，棵数=4+1=5"},
                    {t:"【锯木头】锯一段木头用3分钟，锯成4段要用几分钟？", type:"INPUT", a:"9", e:"次数=4-1=3次，3x3=9"},
                    {t:"【爬楼梯】从1楼到3楼用4分钟，照这样速度，到6楼用几分钟？", type:"INPUT", a:"10", e:"一层用2分钟，1到6是5层"},
                    {t:"【和差问题】小明小红共有20颗糖，小明比小红多4颗，小明有几颗？", type:"INPUT", a:"12", e:"(20+4)/2=12"},
                    {t:"【周期问题】彩灯按'红黄蓝'排列，第10盏灯是什么颜色？", type:"MC", o:["红","黄","蓝"], a:"红", e:"10除以3余1"},
                    {t:"【归一问题】3个排球120元，买5个需要多少钱？", type:"INPUT", a:"200", e:"单价40元"},
                    {t:"【年龄问题】父子年龄和48岁，父是子3倍，父亲几岁？", type:"INPUT", a:"36", e:"48/(3+1)=12, 12x3=36"},
                    {t:"【鸡兔同笼】鸡兔共10只，共28条腿，兔有几只？", type:"INPUT", a:"4", e:"假设全是鸡20腿，多8腿，4只兔"},
                ]
            }
        };
// --- 🆕 新增：挑战模式真题库 (源自上传的单元试卷) ---
        const CHALLENGE_DB = {
            'U1': { name: '第一单元：时分秒', qs: [
                {t:"秒针走一圈是( )秒", type:"INPUT", a:"60", e:"秒针走一小格是1秒，走一圈是60小格，即60秒。"},
                {t:"分针从数字2走到6，经过了( )分", type:"INPUT", a:"20", e:"(6-2)x5=20分钟。"},
                {t:"1分 - 45秒 = ( )秒", type:"INPUT", a:"15", e:"1分=60秒，60-45=15秒。"},
                {t:"电影2:05开始，4:00结束，放映了( )分钟", type:"INPUT", a:"115", e:"3:00到4:00是60分，2:05到3:00是55分，60+55=115分。"},
                {t:"小林每天睡觉9( ) (填单位)", type:"MC", o:["时","分","秒"], a:"时", e:"睡眠时间通常用小时。"},
                {t:"跑50米大约用10( ) (填单位)", type:"MC", o:["时","分","秒"], a:"秒", e:"短跑用秒计时。"},
                {t:"3分5秒 = ( )秒", type:"INPUT", a:"185", e:"3x60+5=185。"},
                {t:"11:05的火车，去车站要25分钟，最晚( )出发 (格式10:40)", type:"INPUT", a:"10:40", e:"11:05 往前推25分。"},
            ]},
            'U3': { name: '第三单元：测量', qs: [
                {t:"1米 - 4分米 = ( )分米", type:"INPUT", a:"6", e:"1米=10分米，10-4=6。"},
                {t:"40毫米 = ( )厘米", type:"INPUT", a:"4", e:"1厘米=10毫米。"},
                {t:"1吨 - 500千克 = ( )千克", type:"INPUT", a:"500", e:"1吨=1000千克。"},
                {t:"一头大象重6( ) (填单位)", type:"MC", o:["克","千克","吨"], a:"吨", e:"大宗物品用吨。"},
                {t:"字典厚度约21( )", type:"MC", o:["毫米","厘米","分米"], a:"毫米", e:"注意是厚度，不是长度。"},
                {t:"飞机每小时飞行800( )", type:"MC", o:["米","千米","分米"], a:"千米", e:"长距离速度用千米/时。"},
                {t:"3千米 = ( )米", type:"INPUT", a:"3000", e:"1千米=1000米。"},
                {t:"6000克 = ( )千克", type:"INPUT", a:"6", e:"1000克=1千克。"},
            ]},
            'U4': { name: '第四单元：万以内加减', qs: [
                {t:"最大的三位数与最小的两位数的和是( )", type:"INPUT", a:"1009", e:"999+10=1009。"},
                {t:"514 - 158 = ( )", type:"INPUT", a:"356", e:"注意退位。"},
                {t:"905 - 615 = ( )", type:"INPUT", a:"290", e:"注意中间有0的退位。"},
                {t:"验算减法时，可以用差 + ( ) = 被减数", type:"MC", o:["减数","加数"], a:"减数", e:"减法验算公式。"},
                {t:"比600少325的数是( )", type:"INPUT", a:"275", e:"600-325。"},
                {t:"自行车原价600，现价535，降价了( )元", type:"INPUT", a:"65", e:"600-535。"},
                {t:"302 + 489 的和大约是( )", type:"INPUT", a:"800", e:"300+500=800。"},
                {t:"一个加数是302，另一个是489，和是( )", type:"INPUT", a:"791", e:"精确计算。"},
            ]},
            'U5': { name: '第五单元：倍的认识', qs: [
                {t:"6的4倍是( )", type:"INPUT", a:"24", e:"用乘法：6 x 4 = 24"},
                {t:"42里面有( )个7", type:"INPUT", a:"6", e:"42÷7=6。"},
                {t:"红花7朵，黄花40朵，黄花比红花的5倍多( )朵", type:"INPUT", a:"5", e:"7x5=35，40-35=5。"},
                {t:"小红8岁，阿姨32岁，阿姨是小红( )倍", type:"INPUT", a:"4", e:"32÷8=4。"},
                {t:"明年小红9岁，阿姨33岁，明年阿姨是小红( )倍", type:"INPUT", a:"3", e:"明年两人都长1岁：(32+1)÷(8+1) = 33÷9 ≈ 3倍(取整)或 3倍多。"}, 
                {t:"5个4可以说成( )的( )倍", type:"MC", o:["4的5倍","5的4倍"], a:"4的5倍", e:"5个4即4x5。"},
                {t:"求一个数的几倍是多少，用( )法", type:"MC", o:["乘","除"], a:"乘", e:"倍数运算定义。"},
            ]},
            'U6': { name: '第六单元：多位数乘一位数', qs: [
                {t:"0和任何数相乘都得( )", type:"INPUT", a:"0", e:"0的乘法特性。"},
                {t:"125 x 8 的积末尾有( )个0", type:"INPUT", a:"3", e:"125x8=1000。"},
                {t:"304 x 5 的积中间有( )个0", type:"MC", o:["0","1","2"], a:"1", e:"304x5=1520，中间无0，末尾有0。"},
                {t:"250 x 4 = ( )", type:"INPUT", a:"1000", e:"算式计算。"},
                {t:"估算 78 x 7 ≈ ( )", type:"INPUT", a:"560", e:"把78看作80，80x7=560。"},
                {t:"502 x 4 的积中间有( )个0", type:"INPUT", a:"2", e:"502x4=2008。"},
                {t:"任何数与( )相乘仍得这个数", type:"INPUT", a:"1", e:"1是乘法单位元。"},
                {t:"买3个资料架，每个198元，大约带( )元", type:"INPUT", a:"600", e:"200x3=600。"},
            ]}
        };
/* --- 题库扩充插件 (基于例题和答案.txt) --- */
        (function() {
            // 精选的新增题目
            const NEW_QUESTIONS = {
                'M1': { // 时分秒
                    BASIC: [
                        {t:"天天跑31秒，兵兵跑28秒，谁跑得快？", type:"MC", o:["天天","兵兵"], a:"兵兵"},
                        {t:"秒针走一圈的时间是1( )", type:"MC", o:["秒","分","时"], a:"分"},
                        {t:"钟表滴答一声大约是1( )", type:"MC", o:["秒","分","时"], a:"秒"},
                        {t:"3分 = ( )秒", type:"INPUT", a:"180"},
                        {t:"1分30秒 = ( )秒", type:"INPUT", a:"90"},
                    ],
                    APP: [
                        {t:"小林跑100米用2分28秒，小玲用3分5秒，小林比小玲快( )秒", type:"INPUT", a:"37", e:"185秒 - 148秒 = 37秒"},
                        {t:"上午8:00出发，8:25到达，路上用了( )分钟", type:"INPUT", a:"25"},
                        {t:"一场足球赛90分钟，16:30结束，开始时间是( ) (格式如 15:00)", type:"INPUT", a:"15:00"},
                    ]
                },
                'M2': { // 加减法(一)
                    BASIC: [
                        {t:"42 + 37 = ( )", type:"INPUT", a:"79"},
                        {t:"69 - 34 = ( )", type:"INPUT", a:"35"},
                        {t:"660比( )大340", type:"INPUT", a:"320"},
                        {t:"300 + 700 = ( )", type:"INPUT", a:"1000"},
                    ],
                    APP: [
                        {t:"面粉厂960袋，运走180和250袋，现在比原来少( )袋", type:"INPUT", a:"430", e:"运走的总和：180+250"},
                        {t:"书店上午卖216本，下午卖378本，全天大约卖( )百本", type:"INPUT", a:"6", e:"200+400=600"},
                        {t:"果园摘300千克苹果，上午卖120，下午卖80，还剩( )千克", type:"INPUT", a:"100"},
                    ]
                },
                'M3': { // 测量
                    BASIC: [
                        {t:"右手一'拃'的长度大约是20( )", type:"MC", o:["毫米","厘米","分米"], a:"厘米"},
                        {t:"一支粉笔长80( )", type:"MC", o:["分米","厘米","毫米"], a:"毫米"},
                        {t:"5千米 = ( )米", type:"INPUT", a:"5000"},
                        {t:"8000千克 = ( )吨", type:"INPUT", a:"8"},
                        {t:"4米 = ( )厘米", type:"INPUT", a:"400"},
                    ],
                    APP: [
                        {t:"2米长的木料锯成5段，每段长( )分米", type:"INPUT", a:"4", e:"2米=20分米，20÷5=4"},
                        {t:"修路1千米，已修600米，还要修( )米", type:"INPUT", a:"400"},
                        {t:"大车运3吨，小车运2吨，运14吨最少运( )次 (都满载)", type:"INPUT", a:"5", e:"大车4次(12吨)+小车1次(2吨)=14吨，共5次"},
                    ]
                },
                'M4': { // 加减法(二)
                    BASIC: [
                        {t:"279 + 752 = ( )", type:"INPUT", a:"1031"},
                        {t:"582 - 413 = ( )", type:"INPUT", a:"169"},
                        {t:"405 - 298 = ( )", type:"INPUT", a:"107"},
                        {t:"验算：差 + ( ) = 被减数", type:"MC", o:["加数","减数"], a:"减数"},
                    ],
                    APP: [
                        {t:"上午接待206人，下午比上午多99人，全天接待( )人", type:"INPUT", a:"511", e:"下午206+99=305，全天206+305"},
                        {t:"电表上月读数613，本月802，本月用电( )度", type:"INPUT", a:"189"},
                        {t:"一套桌椅896元，椅子203元，大约需要( )百元", type:"INPUT", a:"11", e:"900+200=1100"},
                    ]
                },
                'M5': { // 倍的认识
                    BASIC: [
                        {t:"9的9倍是( )", type:"INPUT", a:"81"},
                        {t:"36是9的( )倍", type:"INPUT", a:"4"},
                        {t:"求6的2倍是多少，列式为( )", type:"MC", o:["6÷2","6×2"], a:"6×2"},
                    ],
                    APP: [
                        {t:"小红8岁，妈妈年龄是小红4倍，妈妈( )岁", type:"INPUT", a:"32"},
                        {t:"爷爷72岁，小红8岁，爷爷年龄是小红的( )倍", type:"INPUT", a:"9"},
                        {t:"红气球6个，蓝气球是红的3倍，蓝气球( )个", type:"INPUT", a:"18"},
                    ]
                },
                'M6': { // 多位数乘一位数
                    BASIC: [
                        {t:"12 × 3 = ( )", type:"INPUT", a:"36"},
                        {t:"0 × 36 = ( )", type:"INPUT", a:"0"},
                        {t:"800 × 5 的积末尾有( )个0", type:"INPUT", a:"3", e:"4000"},
                        {t:"24 × 4 = ( )", type:"INPUT", a:"96"},
                    ],
                    APP: [
                        {t:"门票22元，买3张需要( )元", type:"INPUT", a:"66"},
                        {t:"一圈400米，跑4圈是( )米", type:"INPUT", a:"1600"},
                        {t:"每排62棵树，有4排，大约( )棵", type:"INPUT", a:"240"},
                    ]
                },
                'M7': { // 编码 (对应文档中的Unit 6 Lesson 9)
                    BASIC: [
                        {t:"110是( )电话", type:"MC", o:["报警","火警"], a:"报警"},
                        {t:"邮政编码由( )位数字组成", type:"INPUT", a:"6"},
                        {t:"身份证倒数第2位是偶数，表示是( )性", type:"MC", o:["男","女"], a:"女"},
                    ],
                    APP: [
                        {t:"身份证...20120625...，生日是( )月( )日 (格式如0625)", type:"INPUT", a:"0625"},
                        {t:"学号201801051表示2018年入学1班5号男生(末位1)，那201902102是( )生", type:"MC", o:["男","女"], a:"女"},
                    ]
                },
                'M8': { // 分数
                    BASIC: [
                        {t:"把正方形对折两次，每份是它的( )", type:"MC", o:["1/2","1/4"], a:"1/4"},
                        {t:"5个1/8是( )/8 (只填分子)", type:"INPUT", a:"5"},
                        {t:"1 - 3/5 = ( )/5 (只填分子)", type:"INPUT", a:"2"},
                        {t:"分子相同，分母大的分数反而( )", type:"MC", o:["大","小"], a:"小"},
                    ],
                    APP: [
                        {t:"有15块饼干，小明吃了1/3，吃了( )块", type:"INPUT", a:"5"},
                        {t:"绳子剪去1/5，还剩( )/5 (只填分子)", type:"INPUT", a:"4"},
                        {t:"果汁喝了3/5，还剩( )/5 (只填分子)", type:"INPUT", a:"2"},
                    ]
                }
            };

            // 自动合并到现有的 STATIC_DB 中
            if (typeof STATIC_DB !== 'undefined') {
                let count = 0;
                for (let mid in NEW_QUESTIONS) {
                    if (STATIC_DB[mid]) {
                        if (NEW_QUESTIONS[mid].BASIC) {
                            STATIC_DB[mid].BASIC.push(...NEW_QUESTIONS[mid].BASIC);
                            count += NEW_QUESTIONS[mid].BASIC.length;
                        }
                        if (NEW_QUESTIONS[mid].APP) {
                            STATIC_DB[mid].APP.push(...NEW_QUESTIONS[mid].APP);
                            count += NEW_QUESTIONS[mid].APP.length;
                        }
                    }
                }
                console.log(`✅ 成功扩充题库！新增了 ${count} 道来自文档的精选题目。`);
            }
        })();
        /* --- 题库扩充结束 --- */
/* --- 🛡️ 题库扩充插件 (v2.0 去重增强版) --- */
/* 说明：此代码会自动检测并从《例题和答案.txt》中追加约 160 道新题目到游戏中 */
(function() {
    console.log("正在加载扩充题库...");

    const EXPANSION_PACK = {
        'M1': { // 第一单元：时、分、秒
            BASIC: [
                {t:"3人游泳比赛，小明1分20秒，小强60秒，小刚88秒，谁是第一名？", type:"MC", o:["小明","小强","小刚"], a:"小强", e:"时间越短越快，60秒<80秒<88秒"},
                {t:"1分30秒 = ( )秒", type:"INPUT", a:"90"},
                {t:"跑60米，小红14秒，小英12秒，小云13秒，谁跑得最快？", type:"MC", o:["小红","小英","小云"], a:"小英"},
                {t:"做一次深呼吸大约用4( )", type:"MC", o:["秒","分","时"], a:"秒"},
                {t:"2分 = ( )秒", type:"INPUT", a:"120"},
                {t:"10:12正在进行足球赛，可能是( )", type:"MC", o:["中场休息","下半场","颁奖"], a:"下半场", e:"90分钟比赛，10点多还在进行"},
                {t:"3分 = ( )秒", type:"INPUT", a:"180"},
                {t:"11:40到12:05经过了( )分钟", type:"INPUT", a:"25"},
                {t:"8:00开始上课，一节课40分钟，( )下课 (格式 8:40)", type:"INPUT", a:"8:40"},
                {t:"秒针走半圈经过了( )秒", type:"INPUT", a:"30"},
                {t:"1小时 = ( )分", type:"INPUT", a:"60"},
                {t:"分针走1圈是( )小时", type:"INPUT", a:"1"}
            ],
            APP: [
                {t:"小林跑100米用2分28秒，小玲用3分5秒，小林比小玲快( )秒", type:"INPUT", a:"37", e:"185秒 - 148秒 = 37秒"},
                {t:"红红8:00出发，8:25到达图书馆，路上用了( )分钟", type:"INPUT", a:"25"},
                {t:"上午8时出发，经过2小时15分到达，到达时间是( ) (格式 10:15)", type:"INPUT", a:"10:15"},
                {t:"演出9:30开始，提前15分钟是( ) (格式 9:15)", type:"INPUT", a:"9:15"},
                {t:"小明做题，分针走了6小格，他用了( )分钟", type:"INPUT", a:"6"},
                {t:"李阿姨6:30开门，10:00关门，营业了( )小时30分", type:"INPUT", a:"3"},
                {t:"一列火车本应9:15到，晚点25分钟，实际( )到", type:"INPUT", a:"9:40"},
                {t:"小丽4:30放学，路上用35分钟，( )到家 (格式 5:05)", type:"INPUT", a:"5:05"}
            ]
        },
        'M2': { // 第二单元：万以内的加法和减法(一)
            BASIC: [
                {t:"42厘米 + 58厘米 = ( )米", type:"INPUT", a:"1", e:"100厘米=1米"},
                {t:"66比32多( )", type:"INPUT", a:"34"},
                {t:"比58少23的数是( )", type:"INPUT", a:"35"},
                {t:"86 - 37 = ( )", type:"INPUT", a:"49"},
                {t:"28 + 36 = ( )", type:"INPUT", a:"64"},
                {t:"99 - 5 的差的十位是( )", type:"INPUT", a:"9", e:"94，十位是9"},
                {t:"430 + 200 表示4个( )加2个( )", type:"MC", o:["十","百","一"], a:"百"},
                {t:"320 - 70 = ( )", type:"INPUT", a:"250"},
                {t:"660比( )大340", type:"INPUT", a:"320"},
                {t:"850 - 50 = ( )", type:"INPUT", a:"800"},
                {t:"300 + 700 = ( )", type:"INPUT", a:"1000"},
                {t:"54 + 38 = ( )", type:"INPUT", a:"92"}
            ],
            APP: [
                {t:"面粉厂960袋，运走180和250袋，现在比原来少( )袋", type:"INPUT", a:"430", e:"180+250=430"},
                {t:"书店上午卖216本，下午卖378本，全天大约卖( )百本", type:"INPUT", a:"6", e:"200+400=600"},
                {t:"一件上衣180元，裤子120元，一共( )元", type:"INPUT", a:"300"},
                {t:"果园摘300千克，上午卖120，下午卖80，还剩( )千克", type:"INPUT", a:"100"},
                {t:"芸芸送给芳芳11张邮票后两人一样多，原来芸芸比芳芳多( )张", type:"INPUT", a:"22"},
                {t:"手机原价904，现价598，大约便宜了( )百元", type:"INPUT", a:"3", e:"900-600=300"},
                {t:"一根铁丝100米，用去27和38米，短了( )米", type:"INPUT", a:"65"},
                {t:"妈妈有600元，买210元和380元的东西，够吗？(填够或不够)", type:"MC", o:["够","不够"], a:"够", e:"210+380=590"}
            ]
        },
        'M3': { // 第三单元：测量
            BASIC: [
                {t:"一支粉笔长80( )", type:"MC", o:["分米","厘米","毫米"], a:"毫米"},
                {t:"大树高23( )", type:"MC", o:["米","分米","厘米"], a:"米"},
                {t:"银行卡的厚度大约是1( )", type:"MC", o:["毫米","厘米","分米"], a:"毫米"},
                {t:"1米 - 3分米 = ( )分米", type:"INPUT", a:"7"},
                {t:"40毫米 = ( )厘米", type:"INPUT", a:"4"},
                {t:"6000米 + 4000米 = ( )千米", type:"INPUT", a:"10"},
                {t:"1分米 = ( )厘米", type:"INPUT", a:"10"},
                {t:"5千米 = ( )米", type:"INPUT", a:"5000"},
                {t:"8000千克 = ( )吨", type:"INPUT", a:"8"},
                {t:"1吨 - 500千克 = ( )千克", type:"INPUT", a:"500"},
                {t:"计量大宗物品通常用( )作单位", type:"MC", o:["千克","吨","克"], a:"吨"},
                {t:"10米 = ( )厘米", type:"INPUT", a:"1000"}
            ],
            APP: [
                {t:"2米长的木料锯成5段，每段长( )分米", type:"INPUT", a:"4", e:"20÷5=4"},
                {t:"一支铅笔用去20毫米，还剩10厘米，原来长( )厘米", type:"INPUT", a:"12"},
                {t:"修路1千米，已修600米，还要修( )米", type:"INPUT", a:"400"},
                {t:"大车运3吨，小车运2吨，运14吨最少运( )次(满载)", type:"INPUT", a:"5", e:"大车4次(12)+小车1次(2)"},
                {t:"把6厘米的铁丝剪掉3厘米，再减去3毫米，还剩( )毫米", type:"INPUT", a:"27"},
                {t:"学校跑道200米，( )圈正好是1千米", type:"INPUT", a:"5"},
                {t:"水果店苹果1800千克，梨1200千克，共有( )吨", type:"INPUT", a:"3", e:"3000千克=3吨"},
                {t:"小明身高1米5分米，就是( )分米", type:"INPUT", a:"15"}
            ]
        },
        'M4': { // 第四单元：万以内的加法和减法(二)
            BASIC: [
                {t:"三位数加三位数的和不可能是( )位数", type:"MC", o:["三","四","五"], a:"五"},
                {t:"279 + 752 = ( )", type:"INPUT", a:"1031"},
                {t:"503 - 198 的差大约是( )", type:"INPUT", a:"300"},
                {t:"验算：差 + ( ) = 被减数", type:"MC", o:["加数","减数"], a:"减数"},
                {t:"340与153的差是( )", type:"INPUT", a:"187"},
                {t:"724 - 389 = ( )", type:"INPUT", a:"335"},
                {t:"120 - 40 = ( )", type:"INPUT", a:"80"},
                {t:"600 - 450 = ( )", type:"INPUT", a:"150"},
                {t:"1000 - 374 = ( )", type:"INPUT", a:"626"},
                {t:"最大的三位数与最小的四位数的和是( )", type:"INPUT", a:"1999"},
                {t:"405 - 298 = ( )", type:"INPUT", a:"107"},
                {t:"笔算加法时，要从( )位加起", type:"MC", o:["个","十","百"], a:"个"}
            ],
            APP: [
                {t:"植物园上午206人，下午比上午多99人，全天( )人", type:"INPUT", a:"511", e:"206+(206+99)"},
                {t:"电表上月读数613，本月802，本月用电( )度", type:"INPUT", a:"189"},
                {t:"桌子896元，椅子203元，大约准备( )百元", type:"INPUT", a:"11"},
                {t:"工程队上午装302米，下午装198米，上午比下午多装( )米", type:"INPUT", a:"104"},
                {t:"5月比3月多用72吨水，3月用413吨，5月用( )吨", type:"INPUT", a:"485"},
                {t:"剧场楼下525座，比楼上多156座，一共( )座", type:"INPUT", a:"894", e:"525+(525-156)"},
                {t:"图书编号630到780，共有( )本", type:"INPUT", a:"151", e:"780-630+1"},
                {t:"妈妈带800元，买399元和299元的东西，够吗？", type:"MC", o:["够","不够"], a:"够", e:"400+300=700"}
            ]
        },
        'M5': { // 第五单元：倍的认识
            BASIC: [
                {t:"36是9的( )倍", type:"INPUT", a:"4"},
                {t:"( )的9倍是36", type:"INPUT", a:"4"},
                {t:"求6的2倍是多少，列式为( )", type:"MC", o:["6÷2","6×2"], a:"6×2"},
                {t:"81是9的( )倍", type:"INPUT", a:"9"},
                {t:"7的9倍是( )", type:"INPUT", a:"63"},
                {t:"5的6倍是( )", type:"INPUT", a:"30"},
                {t:"24是3的( )倍", type:"INPUT", a:"8"},
                {t:"9的9倍是( )", type:"INPUT", a:"81"},
                {t:"3个8可以看作8的( )倍", type:"INPUT", a:"3"},
                {t:"4个6可以说成6的( )倍", type:"INPUT", a:"4"}
            ],
            APP: [
                {t:"小红8岁，妈妈是小红4倍，妈妈( )岁", type:"INPUT", a:"32"},
                {t:"爷爷72岁，小红8岁，爷爷是小红( )倍", type:"INPUT", a:"9"},
                {t:"红花60朵，蓝花8朵，红花是蓝花8倍，蓝花不变，红花加( )朵", type:"INPUT", a:"4", e:"8x8=64"},
                {t:"小刚看书48页，小明8页，小刚是小明( )倍", type:"INPUT", a:"6"},
                {t:"舞蹈队男生5人，女生是男生3倍，一共( )人", type:"INPUT", a:"20", e:"5+15=20"},
                {t:"跳绳5人，打篮球是跳绳3倍，打篮球( )人", type:"INPUT", a:"15"},
                {t:"小明今年6岁，爸爸36岁，去年爸爸是小明( )倍", type:"INPUT", a:"7", e:"35÷5=7"},
                {t:"书包40元，文具盒8元，书包是文具盒( )倍", type:"INPUT", a:"5"}
            ]
        },
        'M6': { // 第六单元：多位数乘一位数
            BASIC: [
                {t:"800 × 5 的积末尾有( )个0", type:"INPUT", a:"3"},
                {t:"0 × 36 = ( )", type:"INPUT", a:"0"},
                {t:"24 × 4 = ( )", type:"INPUT", a:"96"},
                {t:"310 × 2 = ( )", type:"INPUT", a:"620"},
                {t:"405 × 5 的积中间有( )个0", type:"INPUT", a:"1", e:"2025"},
                {t:"任何数和0相乘都得( )", type:"INPUT", a:"0"},
                {t:"125 × 8 = ( )", type:"INPUT", a:"1000"},
                {t:"250 × 4 = ( )", type:"INPUT", a:"1000"},
                {t:"102 × 4 = ( )", type:"INPUT", a:"408"},
                {t:"305 × 4 的积末尾有( )个0", type:"INPUT", a:"1", e:"1220"},
                {t:"200 × 5 = ( )", type:"INPUT", a:"1000"},
                {t:"900 × 6 = ( )", type:"INPUT", a:"5400"}
            ],
            APP: [
                {t:"门票22元，买3张需要( )元", type:"INPUT", a:"66"},
                {t:"一圈400米，跑4圈是( )米", type:"INPUT", a:"1600"},
                {t:"每排62棵树，4排大约( )棵", type:"INPUT", a:"240"},
                {t:"自行车396元，每月攒140，( )个月够买", type:"INPUT", a:"3"},
                {t:"5架飞机，每架载客280人，共载( )人", type:"INPUT", a:"1400"},
                {t:"726 × 0 × 1 = ( )", type:"INPUT", a:"0"},
                {t:"一套桌椅69元，买7套，带500元( )", type:"MC", o:["够","不够"], a:"够", e:"69x7=483"},
                {t:"油连桶重158，用去一半剩88，油重( )", type:"INPUT", a:"140", e:"(158-88)x2=140"}
            ]
        },
        'M7': { // 第七单元：数字编码 (对应文档中的Unit 6 Lesson 9)
            BASIC: [
                {t:"110是( )电话", type:"MC", o:["报警","火警"], a:"报警"},
                {t:"邮政编码由( )位数字组成", type:"INPUT", a:"6"},
                {t:"身份证倒数第2位是偶数，表示( )", type:"MC", o:["男","女"], a:"女"},
                {t:"身份证号码有( )位", type:"INPUT", a:"18"},
                {t:"火警电话是( )", type:"INPUT", a:"119"},
                {t:"急救电话是( )", type:"INPUT", a:"120"},
                {t:"邮政编码前两位表示( )", type:"MC", o:["省","市","县"], a:"省"},
                {t:"身份证第7-14位表示( )", type:"MC", o:["生日","地址","性别"], a:"生日"}
            ],
            APP: [
                {t:"身份证...20120625...，生日是( )月( )日 (格式0625)", type:"INPUT", a:"0625"},
                {t:"学号201801051表示2018年1班5号男生(末位1)，那201902102是( )生", type:"MC", o:["男","女"], a:"女"},
                {t:"李小林身份证...200512072826，他是( )孩", type:"MC", o:["男","女"], a:"女", e:"倒数第二位是2(偶数)"},
                {t:"小光是2003102361(1年2班36号男)，同班27号女生编号是( )", type:"INPUT", a:"2003102272", e:"末位变2，学号变27"},
                {t:"某教师证号19800216...，出生年份是( )", type:"INPUT", a:"1980"},
                {t:"车牌 赣F·A3256，赣代表( )省", type:"MC", o:["江西","福建","广东"], a:"江西"},
                {t:"身份证第17位是奇数代表( )", type:"MC", o:["男","女"], a:"男"},
                {t:"酒店房间8203表示8楼2区3号，12楼1区5号是( )", type:"INPUT", a:"12105"}
            ]
        },
        'M8': { // 第八单元：分数的初步认识
            BASIC: [
                {t:"把正方形对折两次，每份是它的( )", type:"MC", o:["1/2","1/4"], a:"1/4"},
                {t:"5个1/8是( )/8 (只填分子)", type:"INPUT", a:"5"},
                {t:"1 - 3/5 = ( )/5 (只填分子)", type:"INPUT", a:"2"},
                {t:"分子相同，分母大的分数反而( )", type:"MC", o:["大","小"], a:"小"},
                {t:"1可以看作( )/4", type:"INPUT", a:"4"},
                {t:"3个1/5是( )/5", type:"INPUT", a:"3"},
                {t:"7个1/9是( )/9", type:"INPUT", a:"7"},
                {t:"1/3 ( ) 1/5 (填>或<)", type:"MC", o:[">","<"], a:">"},
                {t:"5/8 - 2/8 = ( )/8", type:"INPUT", a:"3"},
                {t:"1/4 + 2/4 = ( )/4", type:"INPUT", a:"3"},
                {t:"分母是7，分子是3，分数是( )/7", type:"INPUT", a:"3"},
                {t:"把西瓜切成8块，吃了2块，是( )/8 (前提是平均分)", type:"INPUT", a:"2"}
            ],
            APP: [
                {t:"有15块饼干，小明吃了1/3，吃了( )块", type:"INPUT", a:"5"},
                {t:"绳子剪去1/5，还剩( )/5 (只填分子)", type:"INPUT", a:"4"},
                {t:"果汁喝了3/5，还剩( )/5 (只填分子)", type:"INPUT", a:"2"},
                {t:"红气球占总数的2/8，蓝气球占6/8，( )球多", type:"MC", o:["红","蓝"], a:"蓝"},
                {t:"一堆糖12块，拿出1/4，拿出了( )块", type:"INPUT", a:"3"},
                {t:"妈妈吃1/8，爸爸吃3/8，两人一共吃( )/8", type:"INPUT", a:"4"},
                {t:"10片奶片，红红吃3/10，吃了( )片", type:"INPUT", a:"3"},
                {t:"一瓶水，喝了它的1/2，还剩( )", type:"MC", o:["1/2","0"], a:"1/2"}
            ]
        }
    };

    // --- ✅ 修复代码开始：这里是补上的合并逻辑和闭合符号 ---
    if (typeof STATIC_DB !== 'undefined') {
        let count = 0;
        for (let mid in EXPANSION_PACK) {
            // 确保单元存在，没有就新建
            if (!STATIC_DB[mid]) STATIC_DB[mid] = { BASIC: [], APP: [] };
            
            // 合并基础题
            if (EXPANSION_PACK[mid].BASIC) {
                STATIC_DB[mid].BASIC.push(...EXPANSION_PACK[mid].BASIC);
                count += EXPANSION_PACK[mid].BASIC.length;
            }
            // 合并应用题
            if (EXPANSION_PACK[mid].APP) {
                STATIC_DB[mid].APP.push(...EXPANSION_PACK[mid].APP);
                count += EXPANSION_PACK[mid].APP.length;
            }
        }
        console.log(`✅ 扩充题库 v2.0 加载成功！新增 ${count} 道题目。`);
    }
})(); 
// --- ✅ 修复代码结束：一定要有上面那个 })(); ---

/* --- 📂 文档真题导入插件 (包含 M2, M6, M8, M9) --- */
(function() {
    console.log("正在导入文档真题...");

    // 从上传的试卷中提取的精选题目
    const DOC_QUESTIONS = {
        'M2': { // 第二单元：万以内加减法
            BASIC: [
                {t:"45 + 28 = ( )", type:"INPUT", a:"73", e:"进位加法：5+8=13，写3进1"},
                {t:"93 - 47 = ( )", type:"INPUT", a:"46", e:"退位减法：13-7=6"},
                {t:"66比32多( )", type:"INPUT", a:"34"},
                {t:"比58少23的数是( )", type:"INPUT", a:"35"},
                {t:"( )比45多30", type:"INPUT", a:"75"},
                {t:"520 - 370 的结果百位上是( )", type:"MC", o:["1","2","8"], a:"1", e:"520-370=150"},
                {t:"960袋面粉，运走180和250袋，现在比原来少( )袋", type:"INPUT", a:"430", e:"运走的总数就是减少的数：180+250"},
                {t:"200 + 420 = ( )", type:"INPUT", a:"620"},
                {t:"800 - 400 = ( )", type:"INPUT", a:"400"},
                {t:"一个加数是250，另一个是640，和是( )", type:"INPUT", a:"890"}
            ],
            APP: [
                {t:"微波炉原价650，现价570，便宜了( )元", type:"INPUT", a:"80"},
                {t:"坐飞机553元，动车379元，动车比飞机大约便宜( )元 (估算)", type:"MC", o:["100","170","200"], a:"170", e:"550-380=170"},
                {t:"原有522千克苹果，卖出一些后剩294千克，卖出了( )千克", type:"INPUT", a:"228", e:"522-294"},
                {t:"公交车原120人，下60人，上75人，现在有( )人", type:"INPUT", a:"135", e:"120-60+75"},
                {t:"爸爸买鼠标65元，键盘117元，付200元，应找回( )元", type:"INPUT", a:"18"},
                {t:"芸芸送给芳芳11张邮票后两人一样多，原来芸芸比芳芳多( )张", type:"INPUT", a:"22", e:"相差2倍的给出的数量"}
            ]
        },
        'M6': { // 第六单元：多位数乘一位数
            BASIC: [
                {t:"200 × 8 = ( )", type:"INPUT", a:"1600"},
                {t:"17 × 3 = ( )", type:"INPUT", a:"51"},
                {t:"最小的三位数与最大的一位数的积是( )", type:"INPUT", a:"900", e:"100 x 9"},
                {t:"0和任何数相乘都得( )", type:"INPUT", a:"0"},
                {t:"225 × 4 的积是( )位数", type:"MC", o:["三","四"], a:"三", e:"225x4=900"},
                {t:"502 × 4，积的中间有( )个0", type:"INPUT", a:"2", e:"502x4=2008"},
                {t:"304 × 5 的积末尾有( )个0", type:"INPUT", a:"1", e:"304x5=1520"},
                {t:"120 × 4 = ( )", type:"INPUT", a:"480"},
                {t:"49 × 5 大约等于( )", type:"INPUT", a:"250", e:"把49看作50"},
                {t:"101 + 102 + ... + 107 = 104 × ( )", type:"INPUT", a:"7", e:"平均数x个数"}
            ],
            APP: [
                {t:"每箱42元，买5箱，带200元够吗？(填够或不够)", type:"MC", o:["够","不够"], a:"不够", e:"42x5=210，210>200"},
                {t:"每辆车坐29人，300人租10辆车够吗？(填够或不够)", type:"MC", o:["够","不够"], a:"不够", e:"29x10=290，290<300"},
                {t:"725 × 8 = ( )", type:"INPUT", a:"5800"},
                {t:"王叔叔每天加工8个零件，3天完成。如果每天加工6个，( )天完成", type:"INPUT", a:"4", e:"总数24，24÷6=4"},
                {t:"400名同学乘车，前4辆每辆82人，第5辆要坐( )人", type:"INPUT", a:"72", e:"400 - (82x4)"}
            ]
        },
        'M8': { // 第八单元：分数的初步认识
            BASIC: [
                {t:"把苹果平均分4份，每份是它的( )", type:"MC", o:["1/4","1/2"], a:"1/4"},
                {t:"5个1/9是( )/9 (只填分子)", type:"INPUT", a:"5"},
                {t:"1 - 3/7 = ( )/7 (只填分子)", type:"INPUT", a:"4"},
                {t:"分母相同，分子越大，分数越( )", type:"MC", o:["大","小"], a:"大"},
                {t:"2天是一个星期的( )/7", type:"INPUT", a:"2"},
                {t:"15分钟是1小时的( )/4", type:"INPUT", a:"1", e:"15是60的四分之一"},
                {t:"1可以看成( )个1/6", type:"INPUT", a:"6"},
                {t:"5/8 - 2/8 = ( )/8", type:"INPUT", a:"3"},
                {t:"1/2 ( ) 1/4 (填>或<)", type:"MC", o:[">","<"], a:">", e:"分母越大分数越小"}
            ],
            APP: [
                {t:"一堆糖12块，拿出3/4，拿出了( )块", type:"INPUT", a:"9", e:"12÷4×3=9"},
                {t:"16个桃子，平均分4份，3份有( )个", type:"INPUT", a:"12", e:"16÷4×3=12"},
                {t:"林林喝了一杯可乐的3/5，杯中还剩( )/5", type:"INPUT", a:"2"},
                {t:"一段绳子对折3次，每段长是总长的( )", type:"MC", o:["1/3","1/6","1/8"], a:"1/8", e:"2x2x2=8"},
                {t:"猪八戒吃西瓜1/2，孙悟空吃1/6，谁吃得多？", type:"MC", o:["猪八戒","孙悟空"], a:"猪八戒"}
            ]
        },
        'M9': { // 第九单元：集合 (新增单元)
            BASIC: [
                {t:"三(1)班会跳舞18人，会唱歌20人，都会的有8人。会唱歌或跳舞的一共( )人", type:"INPUT", a:"30", e:"18+20-8=30"},
                {t:"爸爸去外婆家每3天一次，舅舅每5天一次，3月1日都去了，下次都去是3月( )日", type:"INPUT", a:"16", e:"3和5的公倍数是15，1+15=16"},
                {t:"昨天和今天都得卫星星的有：小红、小明、小刚。昨天5人，今天6人。一共( )人得星", type:"INPUT", a:"8", e:"5+6-3=8"},
                {t:"排队，从前数妈妈排第8，从后数妈妈也排第8，这队有( )人", type:"INPUT", a:"15", e:"8+8-1=15"},
                {t:"两根木棍各长100厘米，中间重叠20厘米绑在一起，全长( )厘米", type:"INPUT", a:"180", e:"100+100-20"},
                {t:"喜欢篮球10人，足球8人，两种都喜欢3人，只喜欢篮球( )人", type:"INPUT", a:"7", e:"10-3=7"}
            ],
            APP: [
                {t:"语文竞赛12人，数学竞赛14人，都参加5人。全班至少参加一项的有( )人", type:"INPUT", a:"21", e:"12+14-5"},
                {t:"饲养组养鸡32只，养鸭25只，其中有10只鸡和鸭都养了(假设同一笼)。一共有( )个笼子", type:"INPUT", a:"47", e:"集合计算：32+25-10"},
                {t:"10人跳绳，8人踢毽子，两项都参加最多( )人", type:"INPUT", a:"8", e:"踢毽子的人全部也跳绳"},
                {t:"10人跳绳，8人踢毽子，两项都参加最少( )人 (假设班级总分15人)", type:"INPUT", a:"3", e:"10+8-15=3"}
            ]
        }
    };


    // 安全合并到 STATIC_DB
    if (typeof STATIC_DB !== 'undefined') {
        let count = 0;
        
        // --- 修复：先强制初始化 M9，防止报错 ---
        if (!STATIC_DB['M9']) {
            STATIC_DB['M9'] = { BASIC: [], APP: [] };
        }
        // ------------------------------------

        for (let mid in DOC_QUESTIONS) {
            // 如果是新单元(M9)，或者已有单元
            if (STATIC_DB[mid] || mid === 'M9') {
                if (!STATIC_DB[mid]) STATIC_DB[mid] = { BASIC: [], APP: [] };

                // 合并基础题
                if (DOC_QUESTIONS[mid].BASIC) {
                    DOC_QUESTIONS[mid].BASIC.forEach(q => {
                        STATIC_DB[mid].BASIC.push(q);
                        count++;
                    });
                }
                // 合并应用题
                if (DOC_QUESTIONS[mid].APP) {
                    DOC_QUESTIONS[mid].APP.forEach(q => {
                        STATIC_DB[mid].APP.push(q);
                        count++;
                    });
                }
            }
        }
        console.log(`✅ 文档真题加载完成！成功新增 ${count} 道题目（含第九单元）。`);
    }              
})();
    
/* --- 导入结束 --- */
/* --- 🎵 现代Q弹音效系统 (仿蛋仔派对风格) --- */
const SoundSystem = {
    ctx: null,
    init: function() {
        if (!this.ctx) {
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            this.ctx = new AudioContext();
        }
        if (this.ctx.state === 'suspended') this.ctx.resume();
    },
    // 生成Q弹的滑音 (核心技术：频率滑动)
    playBouncy: function(startFreq, endFreq, duration, type='sine', vol=0.3) {
        if (!this.ctx) return;
        const t = this.ctx.currentTime;
        const osc = this.ctx.createOscillator();
        const gain = this.ctx.createGain();
        
        osc.type = type;
        
        // 频率滑行：产生“丢~”或“布鲁~”的果冻效果
        osc.frequency.setValueAtTime(startFreq, t);
        osc.frequency.exponentialRampToValueAtTime(endFreq, t + duration);
        
        // 音量包络：开头大，结尾瞬间消失
        gain.gain.setValueAtTime(vol, t);
        gain.gain.exponentialRampToValueAtTime(0.01, t + duration);
        
        osc.connect(gain);
        gain.connect(this.ctx.destination);
        osc.start();
        osc.stop(t + duration);
    },
    // 播放胜利和弦
    playChord: function(freqs) {
        freqs.forEach((f, i) => {
            setTimeout(() => this.playBouncy(f, f, 0.4, 'sine', 0.15), i * 60);
        });
    },
    play: function(name) {
        this.init();
        switch(name) {
            case 'click': // 🔘 普通点击：像水滴一样的“啵”声
                this.playBouncy(400, 600, 0.1, 'sine', 0.1); 
                break;
            case 'open': // 🎒 打开界面：清脆的“咻”
                this.playBouncy(300, 800, 0.15, 'sine', 0.1);
                break;
            case 'attack': // ✅ 答对：清脆的“叮铃” (三连音)
                this.playBouncy(880, 880, 0.1, 'sine', 0.1);
                setTimeout(() => this.playBouncy(1100, 1100, 0.1, 'sine', 0.1), 80);
                setTimeout(() => this.playBouncy(1760, 1760, 0.3, 'sine', 0.2), 160);
                break;
            case 'hit': // ❌ 答错：可爱的“呃哦” (下沉滑音)
                this.playBouncy(300, 100, 0.3, 'triangle', 0.2); 
                break;
            case 'win': // 🏆 升级/胜利：大三和弦
                this.playChord([523.25, 659.25, 783.99, 1046.50]);
                break;
        }
    }
};

// --- 🎹 背景音乐配置 (中国镜像加速版) ---
const BGM_ASSETS = {
    SOURCES: {
        // 🏠 大厅：真新镇 (Pallet Town) - 温馨回忆，适合平时刷题
        // 使用 raw.gitmirror.com 加速 GitHub 资源
        LOBBY: "https://raw.gitmirror.com/Skinner927/pokemon-html5/master/assets/sounds/bgm/pallet.mp3",
        
        // ⚔️ 战斗：野生怪战斗 (Battle) - 节奏快，提升专注度
        BATTLE: "https://raw.gitmirror.com/Skinner927/pokemon-html5/master/assets/sounds/bgm/battle.mp3",
        
        // 🔥 BOSS：馆主/胜利 (Victory) - 激昂，适合BOSS战
        BOSS: "https://raw.gitmirror.com/Skinner927/pokemon-html5/master/assets/sounds/bgm/victory.mp3"
    }
};
// --- 📻 音乐播放器组件 (优化版) ---
const MusicPlayer = ({ scene, isMuted }) => {
    const audioRef = useRef(null);

    useEffect(() => {
        // 初始化音频对象
        if (!audioRef.current) {
            audioRef.current = new Audio();
            audioRef.current.loop = true; // 循环播放
            audioRef.current.volume = 0.3; // 🔉 音量设为 30%，不干扰答题音效
        }

        const audio = audioRef.current;

        // 1. 确定要播放的音乐链接
        let targetSrc = "";
        if (scene === 'LOBBY') targetSrc = BGM_ASSETS.SOURCES.LOBBY;
        else if (scene === 'BATTLE') targetSrc = BGM_ASSETS.SOURCES.BATTLE;
        else if (scene === 'BOSS') targetSrc = BGM_ASSETS.SOURCES.BOSS;

        // 2. 只有当链接改变时才切歌
        if (targetSrc && audio.src !== targetSrc) {
            audio.src = targetSrc;
            audio.load(); // 强制重新加载
            
            // 尝试播放 (处理浏览器自动播放限制)
            if (!isMuted) {
                const playPromise = audio.play();
                if (playPromise !== undefined) {
                    playPromise.catch(error => {
                        console.log("⏳ 等待用户交互后播放 BGM...");
                    });
                }
            }
        }
    }, [scene]); // 监听场景变化

    // 3. 监听静音开关
    useEffect(() => {
        if (audioRef.current) {
            if (isMuted) {
                audioRef.current.pause();
            } else {
                // 如果取消静音且有歌，就播放
                if (audioRef.current.src) {
                    audioRef.current.play().catch(e => console.log("播放失败:", e));
                }
            }
        }
    }, [isMuted]);

    return null; 
};// ------------------------------------
        const Generator = {
            rand: (min, max) => Math.floor(Math.random() * (max - min + 1)) + min,
            
            // 修复时间计算进率问题 (60进制)
            M1: (g) => { 
                const h=g.rand(7,10);
                const m=g.rand(10,30); 
                const dur=g.rand(20,50);
                
                // 计算结束时间 (手动处理进制)
                let endM = m + dur;
                let endH = h;
                if(endM >= 60) {
                    endH += Math.floor(endM / 60);
                    endM = endM % 60;
                }
                
                // 格式化分钟 (补0)
                const formatM = (min) => min < 10 ? '0'+min : min;
                
                return {
                    t:`小明${h}:${formatM(m)}开始写作业，经过${dur}分钟写完，写完是几时几分？(格式如 10:05)`, 
                    a:`${endH}:${formatM(endM)}`, 
                    type:'INPUT' // 强制填空
                };
            },
            M2: (g) => { 
                const total=g.rand(500,900), p1=g.rand(100,300), p2=g.rand(100,200);
                return {t:`书店有${total}本书，上午卖了${p1}本，下午卖了${p2}本，还剩多少本？`, a:`${total-p1-p2}`, type:'INPUT'};
            },
            M3: (g) => {
                const m = g.rand(3,8);
                const cutDm = g.rand(1, 20); // 剪去的分米数
                return {t:`一根绳子长${m}米，剪去${cutDm}分米，还剩多少分米？`, a:`${m*10 - cutDm}`, type:'INPUT'};
            },
            M4: (g) => {
                const a=g.rand(100,400), b=g.rand(100,400);
                return {t:`电影院楼下有${a}个座位，楼上比楼下多${b}个，楼上有多少个座位？`, a:`${a+b}`, type:'INPUT'};
            },
            M5: (g) => {
                const n = g.rand(4,9), k = g.rand(3,8);
                return {t:`文具盒${n}元，书包的价格是文具盒的${k}倍，书包多少钱？`, a:`${n*k}`, type:'INPUT'};
            },
            M6: (g) => {
                const price = g.rand(20,80), num = g.rand(3,8);
                return {t:`游乐园门票一张${price}元，买${num}张需要多少钱？`, a:`${price*num}`, type:'INPUT'};
            },
            M7: (g) => {
                const y = g.rand(2010,2018);
                return {t:`身份证号 ...${y}0520... 的出生年份是？`, a:`${y}`, type:'INPUT'};
            },
            M8: (g) => {
                const total = g.rand(6,12) * 2;
                return {t:`一堆糖有${total}颗，拿出它的1/2，拿出了几颗？`, a:`${total/2}`, type:'INPUT'};
            },

            M9: (g) => {
                // 简单的集合生成逻辑
                const a = g.rand(10, 20); // 喜欢A的人
                const b = g.rand(10, 20); // 喜欢B的人
                const both = g.rand(3, 8); // 都喜欢的
                return {
                    t: `班级调查：喜欢篮球${a}人，喜欢足球${b}人，两种都喜欢${both}人。喜欢篮球或足球的一共几人？`,
                    a: `${a + b - both}`,
                    type: 'INPUT'
                };
            },

            BOSS: (g) => {
                const n = g.rand(3,6), t = g.rand(2,5);
                return {t:`【锯木头】锯一次要${t}分钟，锯成${n}段要几分钟？`, a:`${t*(n-1)}`, type:'INPUT'};
            },

            get: function(mid, mode, history=[]) {
                if(mid === 'BOSS') {
                    const pool = [...(STATIC_DB.BOSS.APP || []), this.BOSS(this), this.BOSS(this)];
                    return pool[Math.floor(Math.random() * pool.length)];
                }

                // 应用题模式下，如果选中动态生成的题目，确保是 APP 类型
                const staticPool = STATIC_DB[mid]?.[mode] || [];
                let q;
                let attempts = 0;
                
                do {
                    if (staticPool.length > 0 && Math.random() < 0.7) {
                        q = staticPool[Math.floor(Math.random() * staticPool.length)];
                    } else {
                        const genFunc = this[mid] || this.M2;
                        q = genFunc(this);
                        // 如果是应用模式，强制覆盖类型为 INPUT (虽然生成器里大部分已经是INPUT，防止意外)
                        if (mode === 'APP') q.type = 'INPUT'; 
                    }
                    attempts++;
                } while (history.some(h => h === q.t) && attempts < 10);

                return q;
            }
        };

        const KNOWLEDGE_MAP = {
            'M1': { title: '时分秒', nodes: ['1分=60秒\n\n(换算)', '1时=60分\n\n(一大格)', '经过时间\n=\n结束-开始', '秒针\n走一圈\n是60秒', '时针\n走一大格\n是1小时', '分针\n走一小格\n是1分'] },
            'M2': { title: '加减法', nodes: ['相同数位\n对齐', '个位算起\n满十进一', '加法验算\n用减法', '估算\n看成整十\n整百', '减法\n不够减\n向前借一'] },
            'M3': { title: '测量', nodes: ['1千米\n=1000米', '1吨\n=1000千克\n(重物)', '1分米\n=10厘米', '1厘米\n=10毫米', '千米\n(长距离)', '吨\n(大宗物品)'] },
            'M4': { title: '万以内加减', nodes: ['满十进一', '退位减法\n借一当十', '中间有0\n向千位借', '验算减法\n差+减数\n=被减数', '加法验算\n交换加数'] },
            'M5': { title: '倍数', nodes: ['求倍数\n用除法', '求几倍\n是多少\n用乘法', '差不变\n倍数变', '一倍数\n(标准量)'] },
            'M6': { title: '多位数乘法', nodes: ['0乘任何数\n得0', '从个位\n乘起', '满几十\n进几', '整十乘法\n先不看0\n再补0', '0+任何数\n=任何数'] },
            'M7': { title: '编码', nodes: ['身份证\n18位', '倒数第2位\n判性别\n(单男双女)', '出生日期\n第7-14位', '邮编\n6位数', '110报警\n120急救'] },
            'M8': { title: '分数', nodes: ['分子分母\n上子下母', '同分母\n加减\n分母不变', '平均分\n才叫分数', '几分之一\n分母越大\n分数越小', '1可以看作\n分子分母\n相同'] },
'M9': { 
    title: '集合 (韦恩图)', 
    nodes: [
        '重叠问题\n用加减法', 
        '只参加A\n=总数-都参加', 
        '总人数\n=A+B-既A又B', 
        '既A又B\n=A+B-总人数',
        '排队问题\n算重复\n要减1'
    ] 
},
        };

        // --- 2. UI 组件 ---

        const Button = ({ children, color = 'blue', onClick, className = '', disabled, size='md' }) => {
            const colors = {
                blue: "bg-gradient-to-b from-blue-400 to-blue-600 text-white border-b-4 border-blue-800 active:border-b-0",
                green: "bg-gradient-to-b from-green-400 to-green-600 text-white border-b-4 border-green-800 active:border-b-0",
                yellow: "bg-gradient-to-b from-yellow-400 to-yellow-600 text-white border-b-4 border-yellow-800 active:border-b-0",
                red: "bg-gradient-to-b from-red-400 to-red-600 text-white border-b-4 border-red-800 active:border-b-0",
                purple: "bg-gradient-to-b from-purple-400 to-purple-600 text-white border-b-4 border-purple-800 active:border-b-0",
                gray: "bg-gray-200 text-gray-400 border-gray-300",
            };
            
            // 👇 封装点击事件，自动播放“啵”声
            const handleClick = (e) => {
                if (!disabled) {
                    SoundSystem.play('click'); // 播放气泡音
                    if (onClick) onClick(e);
                }
            };

            return (
                <button 
                    onClick={handleClick} 
                    disabled={disabled}
                    className={`game-btn rounded-xl font-black flex items-center justify-center gap-2 transition-all active:translate-y-1 ${disabled ? colors.gray : colors[color]} ${className}`}
                    style={{minHeight: size==='sm'?'40px':'56px'}}
                >
                    {children}
                </button>
            );
        };
        const PokeImg = ({ id, animate = true, className = "" }) => (
            <img 
                src={animate ? `${POKE_URL}${id}.gif` : `${POKE_ART_URL}${id}.png`} 
                className={`object-contain ${className}`}
                onError={(e) => { e.target.onerror = null; e.target.src = `${POKE_ART_URL}${id}.png`; }}
                alt="pokemon"
            />
        );

        // --- 3. 页面组件 ---
// --- 新增组件：背包 ---
        const Backpack = ({ user, onClose, onUse }) => {
            // 统计物品数量
            const counts = {};
            (user.inventory || []).forEach(id => counts[id] = (counts[id] || 0) + 1);
            const uniqueItems = Object.keys(counts).map(id => {
                const item = SHOP_ITEMS.find(i => i.id === id);
                return { ...item, count: counts[id] };
            }).filter(i => i.name);

            return (
                <div className="fixed inset-0 bg-black/60 z-[70] flex items-center justify-center p-4" onClick={onClose}>
                    <div className="bg-white w-full max-w-lg h-[70vh] rounded-3xl flex flex-col overflow-hidden modal-enter" onClick={e=>e.stopPropagation()}>
                        <div className="p-4 bg-blue-50 border-b flex justify-between items-center">
                            <h3 className="font-black text-blue-800 text-lg">🎒 我的背包</h3>
                            <button onClick={onClose} className="text-2xl">×</button>
                        </div>
                        <div className="flex-1 overflow-y-auto p-4 bg-gray-50">
                            {uniqueItems.length === 0 ? (
                                <div className="text-center text-gray-400 mt-20">背包空空如也，去商店看看吧！</div>
                            ) : (
                                <div className="grid grid-cols-2 gap-3">
                                    {uniqueItems.map(item => (
                                        <div key={item.id} className="bg-white p-3 rounded-xl border-2 border-gray-100 shadow-sm flex flex-col items-center relative">
                                            <div className="absolute top-2 right-2 bg-blue-100 text-blue-600 text-xs font-black px-2 py-0.5 rounded-full">x{item.count}</div>
                                            <div className="text-4xl mb-2">{item.icon}</div>
                                            <div className="font-bold text-gray-800">{item.name}</div>
                                            <div className="text-xs text-gray-400 mb-3 text-center">{item.desc}</div>
                                            <Button size="sm" color="blue" onClick={()=>onUse(item)} className="w-full text-xs">使用</Button>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // --- 新增组件：宠物中心 ---
        const PetCenter = ({ user, onClose, onSwitch, onAdopt }) => {
            const [tab, setTab] = useState('MY'); // MY: 我的宠物, ADOPT: 领养中心
            const myPets = user.pets || [user.pid];
            
            return (
                <div className="fixed inset-0 bg-black/60 z-[70] flex items-center justify-center p-4" onClick={onClose}>
                    <div className="bg-white w-full max-w-4xl h-[85vh] rounded-3xl flex flex-col overflow-hidden modal-enter" onClick={e=>e.stopPropagation()}>
                        <div className="p-4 bg-green-50 border-b flex justify-between items-center">
                            <div className="flex gap-4">
                                <button onClick={()=>setTab('MY')} className={`text-lg font-black px-4 py-2 rounded-xl transition-colors ${tab==='MY'?'bg-green-500 text-white':'text-green-700 hover:bg-green-100'}`}>🏠 我的伙伴</button>
                                <button onClick={()=>setTab('ADOPT')} className={`text-lg font-black px-4 py-2 rounded-xl transition-colors ${tab==='ADOPT'?'bg-yellow-500 text-white':'text-yellow-700 hover:bg-yellow-100'}`}>🎁 领养中心</button>
                            </div>
                            <button onClick={onClose} className="text-2xl">×</button>
                        </div>

                        <div className="flex-1 overflow-y-auto p-4 bg-gray-50 scrollbar-hide">
                            {tab === 'MY' ? (
                                <div className="grid grid-cols-3 md:grid-cols-5 gap-4">
                                    {myPets.map(id => (
                                        <div key={id} onClick={()=>onSwitch(id)} className={`bg-white p-2 rounded-2xl border-4 cursor-pointer transition-all hover:scale-105 flex flex-col items-center ${user.pid===id?'border-green-500 shadow-lg bg-green-50':'border-white shadow-sm'}`}>
                                            <div className="w-20 h-20"><PokeImg id={id} className="w-full h-full"/></div>
                                            {user.pid===id && <span className="text-xs font-bold text-green-600 bg-green-100 px-2 rounded-full mt-1">出战中</span>}
                                        </div>
                                    ))}
                                </div>
                            ) : (
                                <div>
                                    <div className="bg-yellow-100 p-4 rounded-xl mb-4 flex justify-between items-center text-yellow-800">
                                        <span className="font-bold">🎫 领养券: {user.tokens || 0} 张 (升级段位获得)</span>
                                    </div>
                                    <div className="grid grid-cols-4 md:grid-cols-6 gap-3">
                                        {PET_DB.map(p => {
                                            const isOwned = myPets.includes(p.id);
                                            return (
                                                <div key={p.id} className={`p-2 rounded-xl border-2 flex flex-col items-center relative ${isOwned ? 'bg-gray-100 border-gray-200 opacity-50' : 'bg-white border-yellow-200'}`}>
                                                    <div className="w-16 h-16 opacity-80"><PokeImg id={p.id} animate={false} className="w-full h-full"/></div>
                                                    {isOwned ? (
                                                        <span className="text-xs font-bold text-gray-400">已拥有</span>
                                                    ) : (
                                                        <button 
                                                            onClick={()=>user.tokens > 0 ? onAdopt(p.id) : alert('领养券不足！快去升级段位吧！')}
                                                            className={`mt-1 text-xs px-2 py-1 rounded-full font-bold text-white ${user.tokens>0?'bg-yellow-500 hover:bg-yellow-600':'bg-gray-300 cursor-not-allowed'}`}
                                                        >
                                                            领养
                                                        </button>
                                                    )}
                                                </div>
                                            )
                                        })}
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

// --- ⚔️ 新增组件：人机PK对战 ---
        const PKBattle = ({ user, onClose, onWin }) => {
            const [diff, setDiff] = useState(null); // null, 'EASY', 'HARD'
            const [q, setQ] = useState(null);
            const [myScore, setMyScore] = useState(0);
            const [aiScore, setAiScore] = useState(0);
            const [aiTimer, setAiTimer] = useState(null);
            const [gameTimer, setGameTimer] = useState(30); // 30秒倒计时
            const [status, setStatus] = useState('SELECT'); // SELECT, BATTLE, END
            const [mistakes, setMistakes] = useState(0); // 记录错误次数

            // 游戏主循环
            useEffect(() => {
                if (status === 'BATTLE') {
                    // 倒计时
                    const t = setInterval(() => {
                        setGameTimer(prev => {
                            if (prev <= 1) {
                                setStatus('END');
                                return 0;
                            }
                            return prev - 1;
                        });
                    }, 1000);

                    // AI 答题逻辑
                    const aiSpeed = diff === 'EASY' ? 3500 : 1500; // 困难模式AI每1.5秒得一分
                    const aiInt = setInterval(() => {
                        // 困难模式90%正确率，简单模式60%
                        const chance = diff === 'EASY' ? 0.6 : 0.9;
                        if (Math.random() < chance) {
                            setAiScore(s => s + 10);
                        }
                    }, aiSpeed);

                    return () => { clearInterval(t); clearInterval(aiInt); };
                }
            }, [status, diff]);

            // 出题
            useEffect(() => {
                if (status === 'BATTLE' && !q) {
                    nextQ();
                }
            }, [status, q]);

            const nextQ = () => {
                // 随机出题，不分单元
                const allQs = [];
                // 混合 STATIC_DB 和 CHALLENGE_DB
                Object.values(STATIC_DB).forEach(u => { if(u.BASIC) allQs.push(...u.BASIC); if(u.APP) allQs.push(...u.APP); });
                Object.values(CHALLENGE_DB).forEach(u => allQs.push(...u.qs));
                
                if(allQs.length > 0) {
                    setQ(allQs[Math.floor(Math.random() * allQs.length)]);
                } else {
                    setQ({t:"1+1=?", a:"2", type:"INPUT"}); // 保底
                }
            };

            const checkAns = (ans) => {
                if (!q) return;
                
                if (ans === q.a) {
                    // ✅ 答对
                    SoundSystem.play('attack');
                    setMyScore(s => s + 10);
                    // speak("不错哦！"); // 觉得吵可以注释掉
                    nextQ(); 
                } else {
                    // ❌ 答错
                    SoundSystem.play('hit');
                    
                    // 检查错误次数 (改为允许错 2 次，第 3 次失败)
                  if (mistakes >= 2) { 
                        alert("💔 答错 3 次，挑战失败！");
                        setStatus('END'); // 直接结束游戏
                    } else {
                        setMistakes(m => m + 1); // 记一次过
                        // 剩余机会 = 总机会(3) - 已错次数(mistakes) - 当前这一次(1)
                        alert(`❌ 答错了！还剩 ${2 - mistakes} 次机会！`);
                }
            }
        }; // <--- 🔴 请务必补上这一个 }; ，这是 checkAns 函数的结束！

            if (status === 'SELECT') {
                return (
                    <div className="fixed inset-0 bg-slate-900 z-[90] flex flex-col items-center justify-center p-6">
                        <h2 className="text-3xl font-black text-white mb-8">⚔️ 选择 PK 难度</h2>
                        <div className="flex gap-6">
                            <button onClick={()=>{setDiff('EASY'); setStatus('BATTLE');}} className="bg-green-500 hover:bg-green-600 text-white p-6 rounded-2xl font-bold text-xl shadow-lg transform hover:scale-110 transition">
                                👶 简单模式
                                <div className="text-xs mt-2 opacity-80">AI 反应较慢</div>
                            </button>
                            <button onClick={()=>{setDiff('HARD'); setStatus('BATTLE');}} className="bg-red-600 hover:bg-red-700 text-white p-6 rounded-2xl font-bold text-xl shadow-lg transform hover:scale-110 transition">
                                😈 困难模式
                                <div className="text-xs mt-2 opacity-80">AI 也是学霸</div>
                            </button>
                        </div>
                        <button onClick={onClose} className="mt-12 text-slate-400 underline">返回大厅</button>
                    </div>
                );
            }

            if (status === 'END') {
                const win = myScore > aiScore;
                return (
                    <div className="fixed inset-0 bg-black/80 z-[90] flex items-center justify-center p-4">
                        <div className="bg-white p-8 rounded-3xl text-center w-full max-w-sm modal-enter">
                            <div className="text-6xl mb-4">{win ? '🏆' : '🤖'}</div>
                            <h2 className="text-3xl font-black text-slate-800 mb-2">{win ? '你赢了！' : '挑战失败...'}</h2>
                            <p className="text-gray-500 mb-6">{win ? '恭喜获得双倍奖励！' : '电脑太强了，下次加油！'}</p>
                            <div className="flex justify-between bg-gray-100 p-4 rounded-xl mb-6 font-bold text-xl">
                                <div className="text-blue-600">我: {myScore}</div>
                                <div className="text-red-500">AI: {aiScore}</div>
                            </div>
                            <Button onClick={()=>onWin(win, diff)} color={win?"yellow":"gray"} className="w-full">{win?"领取奖励":"离开"}</Button>
                        </div>
                    </div>
                );
            }

            return (
                <div className="fixed inset-0 bg-slate-100 z-[80] flex flex-col font-sans">
                    {/* 顶部比分条 */}
                    <div className="bg-slate-800 p-4 flex justify-between items-center text-white shadow-md">
                        <div className="flex items-center gap-3">
                            <div className="w-12 h-12 bg-blue-500 rounded-full border-2 border-white overflow-hidden"><PokeImg id={user.pid} className="w-full h-full"/></div>
                            <div>
                                <div className="text-xs opacity-70">我方得分</div>
                                <div className="text-2xl font-black">{myScore}</div>
                            </div>
                        </div>
                        <div className="text-4xl font-mono font-black text-yellow-400 animate-pulse">{gameTimer}</div>
<div className="flex flex-col items-center">
                            <div className="text-4xl font-mono font-black text-yellow-400 animate-pulse">{gameTimer}</div>
                            <div className="text-xs text-red-300 font-bold mt-1">❤️ 剩余机会: {3 - mistakes}</div>
                        </div>
                        <div className="flex items-center gap-3 text-right">
                            <div>
                                <div className="text-xs opacity-70">{diff==='EASY'?'呆呆兽':'超梦'} (AI)</div>
                                <div className="text-2xl font-black">{aiScore}</div>
                            </div>
                            <div className="w-12 h-12 bg-red-600 rounded-full border-2 border-white overflow-hidden flex items-center justify-center text-2xl">🤖</div>
                        </div>
                    </div>

                    {/* 题目区 */}
                    <div className="flex-1 p-6 flex flex-col justify-center">
                        <div className="bg-white p-8 rounded-3xl shadow-xl text-center mb-8 min-h-[200px] flex items-center justify-center border-4 border-blue-100">
                            <h3 className="text-3xl font-black text-slate-700">{q?.t}</h3>
                        </div>
                        
                        {/* 答题区 - 简化为输入框或选项 */}
                        {q?.type === 'MC' ? (
                            <div className="grid grid-cols-1 gap-3">
                                {q.o.map(opt => (
                                    <button key={opt} onClick={()=>checkAns(opt)} className="w-full p-4 bg-white border-b-4 border-blue-200 rounded-xl font-bold text-xl text-blue-600 active:border-b-0 active:translate-y-1 transition-all">
                                        {opt}
                                    </button>
                                ))}
                            </div>
                        ) : (
                            <div className="grid grid-cols-3 gap-2">
                                {[1,2,3,4,5,6,7,8,9,0].map(n => (
                                    <button key={n} onClick={()=>checkAns(n.toString())} className="h-14 bg-white rounded-lg font-black text-xl shadow-sm border active:bg-gray-100">{n}</button>
                                ))}
                                <button onClick={()=>{
                                    // 针对填空题，这里做一个简化的处理：
                                    // 如果是数字填空，点击键盘直接判断？
                                    // 为了PK流畅，我们简单处理：把正确答案混入几个错误答案变成选择题
                                    const opts = [q.a];
                                    while(opts.length<4) {
                                        const fake = Math.floor(Math.random()*100).toString();
                                        if(!opts.includes(fake)) opts.push(fake);
                                    }
                                    opts.sort(()=>Math.random()-0.5);
                                    // 强制重新渲染为选择题模式（为了PK速度）
                                    setQ({...q, type:'MC', o:opts}); 
                                }} className="col-span-2 h-14 bg-yellow-100 text-yellow-700 rounded-lg font-bold text-sm">显示选项</button>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // --- 🏆 新增组件：挑战之路 (考试模式) ---
        const ChallengePath = ({ onClose, onFinish }) => {
            const [unit, setUnit] = useState(null); // 选择的单元
            const [currentIdx, setCurrentIdx] = useState(0);
            const [answers, setAnswers] = useState({});
            const [isSubmitted, setIsSubmitted] = useState(false);
            const [score, setScore] = useState(0);

            // 1. 选关界面
            if (!unit) {
                return (
                    <div className="fixed inset-0 bg-indigo-900 z-[80] flex flex-col p-6 animate-fade-in text-white">
                        <div className="flex justify-between items-center mb-8">
                            <div>
                                <h2 className="text-3xl font-black text-yellow-400 italic">🔥 挑战之路</h2>
                                <p className="text-indigo-200 text-sm mt-1">单元测试 / 严禁作弊 / 考后解析</p>
                            </div>
                            <button onClick={onClose} className="bg-indigo-700 hover:bg-indigo-600 px-4 py-2 rounded-xl font-bold transition">退出</button>
                        </div>
                        <div className="grid gap-4 overflow-y-auto pb-20">
                            {Object.entries(CHALLENGE_DB).map(([key, data]) => (
                                <button key={key} onClick={()=>setUnit(key)} className="bg-white/10 border border-white/20 p-5 rounded-2xl text-left hover:bg-white/20 hover:border-yellow-400 transition-all group">
                                    <div className="flex justify-between items-center">
                                        <div className="font-bold text-xl text-white group-hover:text-yellow-300">{data.name}</div>
                                        <span className="bg-black/30 px-3 py-1 rounded-full text-xs">共 {data.qs.length} 题</span>
                                    </div>
                                </button>
                            ))}
                        </div>
                    </div>
                );
            }

            const questions = CHALLENGE_DB[unit].qs;
            const q = questions[currentIdx];

            // 交卷逻辑
            const submit = () => {
                if (!confirm("确定要交卷吗？交卷后将显示分数和解析。")) return;
                
                let correct = 0;
                questions.forEach((quest, i) => {
                    const userAns = (answers[i] || "").toString().trim();
                    if (userAns === quest.a) correct++;
                });
                
                const finalScore = Math.round((correct / questions.length) * 100);
                setScore(finalScore);
                setIsSubmitted(true);
                if (finalScore >= 80) onFinish(finalScore);
            };

            // 3. 结果与解析界面
            if (isSubmitted) {
                return (
                    <div className="fixed inset-0 bg-slate-50 z-[80] flex flex-col p-4 overflow-auto">
                        <div className={`text-center py-8 rounded-3xl mb-6 text-white shadow-lg ${score>=90?'bg-gradient-to-r from-yellow-400 to-orange-500':(score>=60?'bg-gradient-to-r from-blue-400 to-indigo-500':'bg-gray-500')}`}>
                            <div className="text-6xl mb-2">{score >= 90 ? '🏆' : (score >= 60 ? '📜' : '🥀')}</div>
                            <h2 className="text-5xl font-black">{score} <span className="text-lg">分</span></h2>
                            <p className="opacity-90 font-bold mt-2">{score>=80 ? '挑战成功！奖励已发放' : '分值不足，请看解析后重试'}</p>
                        </div>
                        
                        <div className="space-y-4 pb-24">
                            {questions.map((quest, i) => {
                                const myAns = answers[i] || "未作答";
                                const isRight = myAns.toString().trim() === quest.a;
                                return (
                                    <div key={i} className={`p-4 rounded-xl border-l-8 bg-white shadow-sm ${isRight ? 'border-green-500' : 'border-red-500'}`}>
                                        <div className="font-bold text-slate-700 mb-2 flex gap-2">
                                            <span className="text-slate-400">#{i+1}</span> {quest.t}
                                        </div>
                                        <div className="bg-slate-50 p-3 rounded-lg text-sm space-y-1">
                                            <div className="flex justify-between">
                                                <span className={isRight ? 'text-green-600 font-bold' : 'text-red-500 font-bold'}>你的答案: {myAns}</span>
                                                {!isRight && <span className="text-green-600 font-bold">正确答案: {quest.a}</span>}
                                            </div>
                                            {!isRight && <div className="text-slate-500 text-xs pt-2 border-t border-slate-200 mt-2">💡 解析: {quest.e}</div>}
                                        </div>
                                    </div>
                                )
                            })}
                        </div>
                        
                        <div className="fixed bottom-0 left-0 right-0 p-4 bg-white border-t border-slate-200">
                            <Button onClick={onClose} color="gray" className="w-full py-3 text-lg">返回大厅</Button>
                        </div>
                    </div>
                );
            }

            // 2. 答题界面
            return (
                <div className="fixed inset-0 bg-slate-100 z-[80] flex flex-col">
                    <div className="bg-white p-4 shadow-sm flex justify-between items-center">
                        <div className="font-black text-xl text-slate-700">
                            <span className="text-indigo-500">#{currentIdx + 1}</span> 
                            <span className="text-slate-300 text-sm mx-2">/</span>
                            <span className="text-slate-400 text-sm">{questions.length}</span>
                        </div>
                        <div className="text-xs bg-indigo-100 text-indigo-600 px-3 py-1 rounded-full font-bold">考试进行中</div>
                    </div>
                    
                    <div className="flex-1 p-6 flex flex-col justify-center">
                        <div className="bg-white p-8 rounded-3xl shadow-lg text-center mb-8 min-h-[180px] flex flex-col items-center justify-center border border-slate-100">
                            <h3 className="text-2xl font-black text-slate-800 leading-relaxed">{q.t}</h3>
                            {q.type === 'MC' && <div className="text-sm text-slate-400 mt-4">- 请选择 -</div>}
                        </div>
                        
                        {/* 选项或输入框 */}
                        {q.type === 'MC' ? (
                            <div className="grid gap-3">
                                {q.o.map(opt => (
                                    <button 
                                        key={opt}
                                        onClick={() => setAnswers({...answers, [currentIdx]: opt})}
                                        className={`p-4 rounded-xl border-2 font-bold text-lg transition-all ${answers[currentIdx]===opt ? 'bg-indigo-600 text-white border-indigo-600 shadow-lg' : 'bg-white border-slate-200 text-slate-600 hover:bg-slate-50'}`}
                                    >
                                        {opt}
                                    </button>
                                ))}
                            </div>
                        ) : (
                            <div className="space-y-4">
                                <input 
                                    type="text" 
                                    value={answers[currentIdx] || ''}
                                    onChange={(e) => setAnswers({...answers, [currentIdx]: e.target.value})}
                                    placeholder="点击输入答案..."
                                    className="w-full p-5 rounded-xl border-2 border-indigo-200 text-center text-2xl font-bold text-indigo-600 outline-none focus:border-indigo-500 focus:ring-4 focus:ring-indigo-100 transition-all bg-white shadow-inner"
                                />
                                <div className="text-center text-xs text-gray-400">请直接输入数字或文字</div>
                            </div>
                        )}
                    </div>

                    <div className="p-4 bg-white border-t border-slate-200 flex gap-3">
                        <Button 
                            color="gray" 
                            onClick={() => setCurrentIdx(Math.max(0, currentIdx - 1))}
                            disabled={currentIdx === 0}
                            className="flex-1"
                        >
                            上一题
                        </Button>
                        
                        {currentIdx < questions.length - 1 ? (
                            <Button 
                                color="blue" 
                                onClick={() => setCurrentIdx(currentIdx + 1)}
                                className="flex-[2]"
                            >
                                下一题
                            </Button>
                        ) : (
                            <Button 
                                color="green" 
                                onClick={submit}
                                className="flex-[2] shadow-green-200 shadow-lg"
                            >
                                📝 交卷
                            </Button>
                        )}
                    </div>
                </div>
            );
        };
    // --- 4. 登录界面 (含赛季公告) ---
        const LoginScreen = ({ onLogin, onMsg, onTeacher }) => {
            const [name, setName] = useState('');
            const [pid, setPid] = useState(25);
            const [tapCount, setTapCount] = useState(0);
            const [showTeacherLogin, setShowTeacherLogin] = useState(false);
            const [pwd, setPwd] = useState('');

            const handleTitleClick = () => {
                const newCount = tapCount + 1; setTapCount(newCount);
                if (newCount >= 5) { setShowTeacherLogin(true); setTapCount(0); }
            };

            if (showTeacherLogin) return (
                <div className="min-h-screen flex items-center justify-center p-4">
                    <div className="glass-card max-w-sm w-full p-8 text-center">
                        <h2 className="text-2xl font-black mb-4">👩‍🏫 教师登录</h2>
                        <input type="password" value={pwd} onChange={e=>setPwd(e.target.value)} placeholder="密码" className="w-full p-3 border-2 rounded-lg mb-4 text-center"/>
                        <div className="flex gap-2"><Button onClick={()=>setShowTeacherLogin(false)} color="gray" className="flex-1">返回</Button><Button onClick={()=>{if(pwd==='8888')onTeacher();else alert('错啦')}} color="blue" className="flex-1">登录</Button></div>
                    </div>
                </div>
            );

            return (
                <div className="min-h-screen flex items-center justify-center p-4 relative overflow-hidden">
                    <div className="glass-card max-w-md w-full p-8 text-center modal-enter z-10 relative">
                        <div className="absolute -top-16 left-1/2 transform -translate-x-1/2 w-32 h-32">
                            <PokeImg id={pid} className="w-full h-full drop-shadow-2xl bounce-custom" />
                        </div>
                        
                        <h1 onClick={handleTitleClick} className="text-4xl font-black text-blue-600 mt-12 mb-4 tracking-wider cursor-pointer">2305数学宝可梦</h1>
                        
                        <div className="bg-orange-50 border-2 border-orange-200 rounded-xl p-4 mb-6 text-left text-sm text-orange-900 shadow-inner">
                            <h3 className="font-black text-lg mb-2 text-orange-600 flex items-center">🔥 S1赛季：加减法风暴</h3>
                            <ul className="list-disc pl-4 space-y-1">
                                <li>📅 <strong>时间：</strong> 12月限定赛季</li>
                                <li>🏆 <strong>规则：</strong> 赛季结束段位/金币重置</li>
                                <li>🎁 <strong>大奖：</strong> 前三名赢取 <span className="font-bold text-red-500">实体大公仔</span></li>
                            </ul>
                        </div>

                        <div className="flex justify-start gap-3 mb-6 overflow-x-auto py-2 scrollbar-hide px-2">
                            {STARTERS.map(id => (
                                <div key={id} onClick={()=>setPid(id)} className={`flex-shrink-0 w-14 h-14 rounded-xl border-4 cursor-pointer transition-transform hover:scale-110 bg-white ${pid===id?'border-yellow-400 shadow-lg':'border-gray-100'}`}>
                                    <PokeImg id={id} className="w-full h-full p-1" animate={false}/>
                                </div>
                            ))}
                        </div>

                        <input value={name} onChange={e=>setName(e.target.value)} placeholder="请输入你的名字" className="w-full p-4 rounded-xl border-4 border-blue-100 bg-blue-50 text-center font-bold text-xl outline-none focus:border-blue-400 transition-colors mb-4"/>
                        <Button onClick={()=>name && onLogin(name, pid)} color="yellow" className="w-full text-xl">开始冒险 GO!</Button>
                    </div>
                </div>
            );
        };

        const speak = (text) => {
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel(); 
                const u = new SpeechSynthesisUtterance(text);
                u.lang = 'zh-CN'; u.rate = 1.0; 
                window.speechSynthesis.speak(u);
            }
        };

        const KnowledgeMap = ({ mid, onClose, onAddCoin, canLoot }) => {
            const data = KNOWLEDGE_MAP[mid];
            const [isFullyOpen, setIsFullyOpen] = useState(false);
            
            useEffect(() => { setTimeout(() => setIsFullyOpen(true), 100); }, []);

            if(!data) return null;
            return (
                <div className="fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4" onClick={onClose}>
                    <div className="relative bg-amber-100 w-full max-w-4xl h-[80vh] rounded-xl overflow-hidden shadow-2xl flex flex-col items-center justify-center border-y-8 border-amber-800" onClick={e=>e.stopPropagation()}>
                        <h2 className="text-3xl font-black text-amber-900 mt-8 mb-4 border-b-4 border-amber-900/20 pb-2">{data.title} - 知识地图</h2>
                        <div className="flex-1 w-full p-8 grid grid-cols-2 md:grid-cols-3 gap-6 overflow-y-auto">
                             {data.nodes.map((node, i) => (
                                <div key={i} className="bg-white/60 p-4 rounded-lg border-2 border-amber-800/30 text-center flex items-center justify-center font-bold text-amber-900 shadow-sm hover:scale-105 transition-transform">
                                    {node}
                                </div>
                             ))}
                        </div>
                        <div className="absolute top-4 right-4"><button onClick={onClose} className="text-4xl text-amber-900 hover:text-red-600">×</button></div>
                        {canLoot && (
                            <button onClick={(e)=>{e.stopPropagation(); alert("获得50金币！"); onAddCoin(50); onClose();}} className="absolute bottom-8 right-8 animate-bounce">
                                <span className="text-6xl">💰</span>
                            </button>
                        )}
                    </div>
                </div>
            );
        };

        const TeacherPanel = ({ onClose }) => (
            <div className="fixed inset-0 bg-white z-[80] flex flex-col p-6">
                <div className="flex justify-between items-center mb-6"><h2 className="text-3xl font-black">教师后台</h2><button onClick={onClose} className="text-xl bg-gray-200 px-4 py-2 rounded">关闭</button></div>
                <div className="text-center text-gray-400 py-10">数据加载中...</div>
            </div>
        );

        const Leaderboard = ({ userExp, onClose }) => (
            <div className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-6" onClick={onClose}>
                <div className="bg-white w-full max-w-md rounded-3xl p-6 modal-enter" onClick={e=>e.stopPropagation()}>
                    <h3 className="text-2xl font-black text-yellow-600 mb-4">🏆 排行榜</h3>
                    <div className="p-4 bg-yellow-50 rounded-xl border-2 border-yellow-200 flex justify-between items-center">
                        <span className="font-bold">我</span>
                        <span className="font-black text-blue-600">{userExp} EXP</span>
                    </div>
                </div>
            </div>
        );

        const RankInfoModal = ({ currentExp, onClose }) => (
            <div className="fixed inset-0 bg-black/60 z-[65] flex items-center justify-center p-4" onClick={onClose}>
                <div className="bg-white w-full max-w-md rounded-3xl p-6 modal-enter" onClick={e=>e.stopPropagation()}>
                    <div className="flex justify-between mb-4 border-b pb-2"><h3 className="font-black text-gray-800">段位表</h3><button onClick={onClose}>×</button></div>
                    <div className="space-y-2 max-h-[60vh] overflow-y-auto">
                        {RANKS.map((r, i) => (
                            <div key={i} className={`p-2 flex justify-between rounded ${currentExp>=r.minExp?'bg-blue-50 text-blue-800':'bg-gray-50 text-gray-400'}`}>
                                <span>{r.icon} {r.name}</span><span className="text-xs">{r.minExp} EXP</span>
                            </div>
                        ))}
                    </div>
                </div>
            </div>
        );

        const TimeLimitModal = ({ onClose }) => null; // 简化处理

        // --- 5. Dashboard (仪表盘) ---
        const Dashboard = ({ user, onStart, onShop, onWrong, onMsg, onLogout, onOpenPK, onOpenChallenge, onOpenPet, onOpenBag, onOpenGacha, onEasterEgg, isMusicOn, onToggleMusic }) => {
            const [showRank, setShowRank] = useState(false);
            const [showLeader, setShowLeader] = useState(false);
            const rank = RANKS.find((r, i) => user.exp >= r.minExp && (i === RANKS.length - 1 || user.exp < RANKS[i+1].minExp)) || RANKS[0];

            // 封装带音效的点击函数，减少重复代码
            const clickWithSound = (action) => {
                SoundSystem.play('click'); // 播放啵啵声
                if (action) action();
            };

            return (
                <div className="min-h-screen p-4 pb-24">
                    {/* --- 👇 顶部仪表盘 (含彩蛋 + 手机适配) 👇 --- */}
                    <div className="glass-card !p-3 !rounded-2xl mb-4 flex flex-col md:flex-row justify-between items-center gap-3">
                        
                        {/* 左侧：头像与等级 */}
                        <div className="flex items-center gap-3 w-full md:w-auto border-b md:border-b-0 pb-2 md:pb-0 border-gray-100">
                            {/* 🥚 彩蛋 1：点击头像 (加金币) */}
                            <div className="w-14 h-14 bg-white rounded-full border-4 border-blue-100 overflow-hidden shrink-0 cursor-pointer active:scale-90 transition-transform" 
                                 onClick={() => { 
                                     clickWithSound(); 
                                     if(confirm('要触发隐藏彩蛋吗？')) onEasterEgg(); 
                                 }}>
                                <PokeImg id={user.pid} className="w-full h-full" />
                            </div>
                            
                            <div className="flex-1">
                                {/* ✅ 修复：点击名字/段位图标 -> 显示段位表 */}
                                <div className="font-black text-gray-800 text-lg flex items-center gap-2 cursor-pointer"
                                     onClick={() => { 
                                         clickWithSound(); 
                                         setShowRank(true); // 确保这里只调用显示段位
                                     }}>
                                    {user.name} 
                                    <span className={`text-xs px-2 py-0.5 rounded-full ${rank.color} border shrink-0`}>
                                        {rank.icon} {rank.name}
                                    </span>
                                </div>
                                
                                {/* 🥚 彩蛋 2：点击 EXP 数字 -> 触发彩蛋 */}
                                <div className="text-xs font-bold text-gray-400 cursor-pointer hover:text-yellow-500"
                                     onClick={(e) => { 
                                         e.stopPropagation(); // 防止冒泡，点这里只触发彩蛋，不弹段位表
                                         clickWithSound(); 
                                         onEasterEgg(); 
                                     }}>
                                    EXP: {user.exp} | ⚡{user.stamina}
                                </div>
                            </div>
                        </div>

                        {/* 右侧：功能按钮组 (带音效) */}
                        <div className="flex gap-2 flex-wrap justify-end w-full md:w-auto">
                            <button onClick={() => clickWithSound(onLogout)} className="w-10 h-10 bg-gray-200 rounded-xl font-bold text-xs shadow-sm active:scale-95 transition-transform">退</button>
                        {/* 🎵 音乐开关 */}
                            <button 
                                onClick={() => clickWithSound(onToggleMusic)} 
                                className={`w-10 h-10 rounded-xl font-bold text-xl shadow-sm active:scale-95 transition-transform border-b-4 ${isMusicOn ? 'bg-yellow-100 border-yellow-200' : 'bg-gray-200 border-gray-300 grayscale'}`}
                            >
                                {isMusicOn ? '🎵' : '🔇'}
                            </button>
                            <button onClick={() => clickWithSound(onOpenGacha)} className="w-10 h-10 bg-purple-100 rounded-xl border-b-4 border-purple-200 text-xl active:border-b-0 active:translate-y-1 active:scale-95 transition-transform">🔮</button>
                            <button onClick={() => clickWithSound(onOpenPet)} className="w-10 h-10 bg-green-100 rounded-xl border-b-4 border-green-200 text-xl relative active:border-b-0 active:translate-y-1 active:scale-95 transition-transform">
                                🐾 {user.tokens>0 && <span className="wrong-tag">{user.tokens}</span>}
                            </button>
                            
                            {/* 📕 错题本 */}
                            <button onClick={() => clickWithSound(onWrong)} className="w-10 h-10 bg-red-100 rounded-xl border-b-4 border-red-200 text-xl active:border-b-0 active:translate-y-1 active:scale-95 transition-transform">📕</button>
                            
                            <button onClick={() => clickWithSound(onOpenBag)} className="w-10 h-10 bg-blue-100 rounded-xl border-b-4 border-blue-200 text-xl active:border-b-0 active:translate-y-1 active:scale-95 transition-transform">🎒</button>
                            <button onClick={() => clickWithSound(onShop)} className="h-10 px-3 bg-yellow-100 rounded-xl border-b-4 border-yellow-200 font-black text-yellow-700 active:border-b-0 active:translate-y-1 active:scale-95 transition-transform shrink-0">
                                🪙 {user.coins}
                            </button>
                        </div>
                    </div>
                    {/* --- 👆 仪表盘结束 👆 --- */}

                    {/* 中间入口 */}
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        <div onClick={() => clickWithSound(onOpenPK)} className="bg-gradient-to-br from-blue-500 to-indigo-600 rounded-2xl p-4 text-white shadow-lg cursor-pointer active:scale-95 transition-transform hover:scale-[1.02]">
                            <div className="text-4xl mb-2">⚔️</div><div className="font-black text-xl">PK 对战</div>
                        </div>
                        <div onClick={() => clickWithSound(onOpenChallenge)} className="bg-gradient-to-br from-orange-400 to-red-500 rounded-2xl p-4 text-white shadow-lg cursor-pointer active:scale-95 transition-transform hover:scale-[1.02]">
                            <div className="text-4xl mb-2">🏆</div><div className="font-black text-xl">挑战之路</div>
                        </div>
                    </div>

                    {/* 下方单元格列表 */}
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-5">
                        {Object.keys(ENEMIES).map((mid, idx) => {
                            const isBoss = mid === 'BOSS';
                            const isLocked = isBoss && user.exp < 1200;

                            return (
                                <div key={mid} className={`glass-card p-5 flex flex-col relative overflow-hidden transition-all ${isLocked ? 'grayscale opacity-90' : 'hover:scale-[1.02]'}`}>
                                    
                                    {isLocked && (
                                        <div className="absolute inset-0 z-20 bg-gray-100/50 backdrop-blur-[2px] flex flex-col items-center justify-center text-center p-4">
                                            <div className="text-4xl mb-2">🔒</div>
                                            <div className="font-black text-gray-600 bg-white/80 px-3 py-1 rounded-lg border-2 border-gray-300">
                                                需达到 黄金段位
                                            </div>
                                            <div className="text-xs text-gray-500 mt-1 font-bold">当前EXP: {user.exp}/1200</div>
                                        </div>
                                    )}

                                    <div className="flex justify-between items-start mb-4 pl-1">
                                        <div>
                                            <h3 className={`font-black text-2xl mb-1 ${isBoss ? 'text-red-600' : 'text-slate-800'}`}>
                                                {idx === Object.keys(ENEMIES).length - 1 ? '🔥 BOSS关' : `第 ${idx+1} 单元`}
                                            </h3>
                                            <div className="text-base text-slate-500 font-bold bg-white/50 px-2 py-1 rounded-lg inline-block">
                                                {UNIT_NAMES[mid]}
                                            </div>
                                        </div>
                                        <div className="w-20 h-20 opacity-90 -mt-2">
                                            <PokeImg id={ENEMIES[mid][0]} className="w-full h-full drop-shadow-md"/>
                                        </div>
                                    </div>

                                    <div className="grid grid-cols-2 gap-3 mt-auto">
                                        <Button disabled={isLocked} onClick={()=>onStart(mid, 'BASIC')} color="blue" className="w-full !text-xl py-4 shadow-blue-200">
                                            基础
                                        </Button>
                                        <Button disabled={isLocked} onClick={()=>onStart(mid, 'APP')} color="green" className="w-full !text-xl py-4 shadow-green-200">
                                            应用
                                        </Button>
                                    </div>
                                </div>
                            );
                        })}
                    </div>

                    {showRank && <RankInfoModal currentExp={user.exp} onClose={()=>setShowRank(false)} />}
                    {showLeader && <Leaderboard userExp={user.exp} onClose={()=>setShowLeader(false)} />}
                </div>
            );
        };

        // --- 核心战斗组件 ---
        const Battle = ({ mid, mode, user, onClose, onRes, onShowMap }) => {
            const [q, setQ] = useState(null);
            const [ans, setAns] = useState('');
            const [enemy, setEnemy] = useState(ENEMIES[mid][0]);
            const [status, setStatus] = useState('idle');
            const [history, setHistory] = useState([]);
            const [showCoin, setShowCoin] = useState(false);
            const [showExplanation, setShowExplanation] = useState(false); 

            useEffect(() => {
                setEnemy(ENEMIES[mid][Math.floor(Math.random()*ENEMIES[mid].length)]);
                nextQ();
            }, []);

            const nextQ = () => {
                const newQ = Generator.get(mid, mode, history);
                setHistory(prev => [...prev.slice(-4), newQ.t]); 
                setQ(newQ);
                setAns('');
                setStatus('idle');
                setShowCoin(false);
                setShowExplanation(false);
            };

            const check = () => {
                if(!ans) return;
                const right = ans.trim() === q.a;
                if(right) {
                    SoundSystem.play('attack'); // ✅ 播放清脆的叮铃声
                    setStatus('attack');
                    speak("太棒了！"); 
                    if(window.confetti) window.confetti({ origin: { y: 0.7 } });
                    setTimeout(() => setShowCoin(true), 400); 
                    setTimeout(() => { onRes(true, q); nextQ(); }, 1500);
                } else {
                    SoundSystem.play('hit'); // ❌ 播放可爱的下沉音
                    setStatus('hit');
                    speak(`不对哦。正确答案是${q.a}`);
                    setTimeout(() => { onRes(false, q); setShowExplanation(true); }, 500);
                }
            };
            if(!q) return null;

            return (
                <div className="fixed inset-0 bg-gray-900 z-50 flex flex-col">
                    <div className={`flex-1 relative overflow-hidden ${mid==='BOSS'?'bg-gradient-to-b from-gray-900 to-purple-900':'bg-gradient-to-b from-blue-300 to-blue-100'}`}>
                        <button onClick={onClose} className="absolute top-4 left-4 bg-white/50 backdrop-blur px-3 py-1 rounded-full font-bold text-sm z-20">🏳️ 撤退</button>
                        <div className={`absolute top-12 right-8 w-40 h-40 flex items-center justify-center transition-all ${status==='attack' && !showCoin ? 'hit-anim' : ''}`}>
                            {showCoin ? <div className="text-6xl coin-appear">🪙</div> : <div className={showCoin?'hidden':(status==='attack'?'coin-transform':'')}><PokeImg id={enemy} className="w-full h-full drop-shadow-xl"/></div>}
                        </div>
                        <div className={`absolute bottom-8 left-8 w-32 h-32 transition-all ${status==='attack'?'attack-anim':''}`}>
                            <PokeImg id={user.pid} isBack={true} className="w-full h-full drop-shadow-xl" />
                        </div>
                    </div>

                    <div className="bg-white rounded-t-3xl p-6 shadow-2xl relative -mt-6">
                        <div className="text-center mb-6"><h2 className="text-xl font-black text-gray-800 leading-relaxed">{q.t}</h2></div>
                        {q.type === 'MC' ? (
                            <div className="grid gap-3">{q.o.map(opt => <Button key={opt} onClick={()=>{setAns(opt); setTimeout(check, 100);}} color={ans===opt?'yellow':'blue'} className="w-full !text-lg">{opt}</Button>)}</div>
                        ) : (
                            <div>
                                <div className="bg-gray-100 p-4 rounded-xl text-center text-3xl font-black text-blue-600 mb-4 h-16 border-2 border-blue-200">{ans}</div>
                                <div className="grid grid-cols-4 gap-2">
                                    {[1,2,3,4,5,6,7,8,9,0].map(n => <button key={n} onClick={()=>setAns(s=>s+n)} className="h-12 bg-white border rounded-lg text-xl font-bold shadow-sm">{n}</button>)}
                                    <button onClick={()=>setAns(s=>s+':')} className="h-12 bg-white border rounded-lg text-xl font-bold">:</button>
                                    <button onClick={()=>setAns(s=>s.slice(0,-1))} className="h-12 bg-red-50 text-red-500 rounded-lg font-bold">⌫</button>
                                    <button onClick={check} className="h-12 col-span-2 bg-green-500 text-white rounded-lg font-bold shadow">提交</button>
                                </div>
                            </div>
                        )}
                    </div>

                    {showExplanation && (
                        <div className="absolute inset-0 bg-black/60 z-50 flex items-center justify-center p-6 backdrop-blur-sm">
                            <div className="bg-white w-full max-w-sm rounded-3xl p-6 modal-enter text-center shadow-2xl border-4 border-red-100">
                                <div className="text-4xl mb-2">🥀</div>
                                <h3 className="text-xl font-black text-gray-800 mb-2">很遗憾，答错了</h3>
                                <div className="bg-red-50 p-4 rounded-xl text-left mb-6">
                                    <p className="text-gray-500 text-xs mb-1">正确答案是：</p>
                                    <p className="text-2xl font-black text-green-600 mb-3">{q.a}</p>
                                    <div className="border-t border-red-200 pt-2">
                                        <span className="font-bold text-red-500 text-sm">💡 解析：</span>
                                        <span className="text-gray-700 text-sm">{q.e || "这就去查看知识地图吧！"}</span>
                                    </div>
                                </div>
                                <div className="flex gap-2">
                                    <Button onClick={()=>{onClose(); onShowMap(mid);}} color="yellow" className="flex-1 text-sm">📖 学习知识点</Button>
                                    <Button onClick={nextQ} color="blue" className="flex-1 text-sm">👊 再来一题</Button>
                                </div>
                            </div>
                        </div>
                   )}
                </div>
            );
        };

        const LevelUpModal = ({ rank, onClose }) => (
            <div className="fixed inset-0 bg-black/80 z-[70] flex items-center justify-center p-6" onClick={onClose}>
                <div className="text-center levelup-enter">
                    <div className="text-8xl mb-4 animate-bounce">{rank.icon}</div>
                    <h2 className="text-4xl font-black text-yellow-400 mb-2">等级提升！</h2>
                    <p className="text-white text-xl font-bold">晋升为 <span className="text-yellow-300">{rank.name}</span> ！</p>
                    <Button onClick={onClose} color="yellow" className="mt-8 w-40 mx-auto">太棒了！</Button>
                </div>
            </div>
        );

        const GachaMachine = ({ user, onClose, onDraw }) => {
            const [isSpinning, setIsSpinning] = useState(false);
            const [prize, setPrize] = useState(null);

            const handleDraw = (type) => {
                const cost = type === 'normal' ? 200 : 1000;
                if (user.coins < cost) { alert("金币不足！"); return; }
                
                setIsSpinning(true); 
                setPrize(null);
                
                // 播放抽奖音效
                SoundSystem.play('open');

                setTimeout(() => {
                    const rand = Math.random();
                    let result;

                    if (type === 'normal') {
                        // 普通盲盒逻辑不变
                        if(rand < 0.5) result = { name: "100 经验", type: "exp", val: 100, img: "✨" };
                        else if(rand < 0.9) result = { name: "体力药水", type: "item", id: "item7", img: "🥛" };
                        else result = { name: "小猫表情包", type: "item", id: "item2", img: "🐱" };
                    } else {
                        // 🔥 高级盲盒逻辑 (调整概率 + 保底)
                        
                        // 1. 读取当前的保底计数 (如果没有就默认为0)
                        let pityCount = user.pityCount || 0;
                        pityCount++; // 抽一次加一次

                        if (pityCount >= 5) {
                            // 🎉 触发保底：第5次必出小鼻嘎
                            result = { name: "小鼻嘎 (保底)", type: "item", id: "item3", img: "🐻‍❄️" };
                            pityCount = 0; // 重置保底
                        } else {
                            // 🎲 正常概率：降低好东西的爆率
                            // 10% 概率出高级玩具，90% 概率出经验
                            if (rand < 0.1) {
                                result = { name: "高级玩具", type: "item", id: "item3", img: "🧸" };
                                pityCount = 0; // 中了就重置保底
                            } else {
                                result = { name: "500 经验", type: "exp", val: 500, img: "🌟" };
                            }
                        }
                        
                        // 把新的保底数传回去保存
                        result.newPityCount = pityCount;
                    }

                    setPrize(result); 
                    setIsSpinning(false);
                    SoundSystem.play('win'); // 中奖音效
                    onDraw(cost, result);
                }, 2000);
            };

            return (
                <div className="fixed inset-0 bg-black/80 z-[90] flex items-center justify-center p-4" onClick={onClose}>
                    <div className="bg-white w-full max-w-md rounded-3xl p-6 text-center modal-enter" onClick={e=>e.stopPropagation()}>
                        <button onClick={onClose} className="absolute top-4 right-4 text-2xl">×</button>
                        <h2 className="text-3xl font-black text-purple-600 mb-2">🔮 幸运盲盒</h2>
                        <div className="text-xs text-gray-400 mb-4">高级盲盒 5 次必得小鼻嘎</div>
                        
                        <div className="h-48 bg-purple-50 rounded-2xl flex items-center justify-center mb-8 border-4 border-purple-200">
                            {isSpinning ? <div className="text-8xl animate-spin">📦</div> : prize ? <div className="animate-bounce"><div className="text-6xl mb-2">{prize.img}</div><div className="font-bold text-xl text-purple-800">{prize.name}</div></div> : <div className="text-6xl opacity-50">❓</div>}
                        </div>
                        <div className="grid grid-cols-2 gap-4">
                            <button onClick={() => !isSpinning && handleDraw('normal')} className="bg-blue-100 p-4 rounded-xl font-bold text-blue-800">普通 (200)</button>
                            <button onClick={() => !isSpinning && handleDraw('premium')} className="bg-yellow-100 p-4 rounded-xl font-bold text-yellow-800">高级 (1000)</button>
                        </div>
                    </div>
                </div>
            );
        };
        const Shop = ({ user, onClose, onBuy }) => (
            <div className="fixed inset-0 bg-black/60 z-[60] flex items-center justify-center p-4" onClick={onClose}>
                <div className="bg-white w-full max-w-lg h-[80vh] rounded-3xl flex flex-col overflow-hidden modal-enter" onClick={e=>e.stopPropagation()}>
                    <div className="p-4 bg-yellow-50 border-b flex justify-between items-center"><h3 className="font-black text-yellow-800 text-lg">商店</h3><button onClick={onClose} className="text-2xl">×</button></div>
                    <div className="flex-1 overflow-y-auto p-4 grid grid-cols-2 gap-3 bg-gray-50">
                        {SHOP_ITEMS.map(item => (
                            <div key={item.id} className="bg-white p-3 rounded-xl border flex flex-col items-center text-center">
                                <div className="text-4xl mb-2">{item.icon}</div>
                                <div className="font-bold">{item.name}</div>
                                <div className="text-xs text-gray-400 mb-3">{item.desc}</div>
                                <Button size="sm" color="yellow" onClick={()=>onBuy(item)} className="w-full text-sm">🪙 {item.price}</Button>
                            </div>
                        ))}
                    </div>
                </div>
            </div>
        );

        const Mailbox = ({ msgs, onSend, onClose }) => {
            const [txt, setTxt] = useState('');
            return (
                <div className="fixed inset-0 bg-black/60 z-[60] flex items-center justify-center p-4" onClick={onClose}>
                    <div className="bg-white w-full max-w-md h-[60vh] rounded-3xl flex flex-col overflow-hidden modal-enter" onClick={e=>e.stopPropagation()}>
                        <div className="p-4 bg-purple-50 border-b flex justify-between items-center"><h3 className="font-black text-purple-800 text-lg">信箱</h3><button onClick={onClose} className="text-2xl">×</button></div>
                        <div className="flex-1 overflow-y-auto p-4 space-y-3 bg-gray-50">
                            {msgs.map((m,i)=>(<div key={i} className={`p-3 rounded-xl text-sm ${m.isMe?'bg-blue-100 ml-8':'bg-white mr-8 border'}`}>{m.text}</div>))}
                        </div>
                        <div className="p-3 border-t bg-white flex gap-2">
                            <input value={txt} onChange={e=>setTxt(e.target.value)} className="flex-1 bg-gray-100 rounded-lg px-3 outline-none" placeholder="写信..." />
                            <button onClick={()=>{if(txt){onSend(txt); setTxt('')}}} className="bg-purple-500 text-white px-4 rounded-lg font-bold">发送</button>
                        </div>
                    </div>
                </div>
            );
        };

      const WrongBook = ({ list, onClose }) => (
            <div className="fixed inset-0 bg-black/60 z-[60] flex items-center justify-center p-4" onClick={onClose}>
                <div className="bg-white w-full max-w-md h-[70vh] rounded-3xl flex flex-col overflow-hidden modal-enter" onClick={e=>e.stopPropagation()}>
                    <div className="p-4 bg-red-50 border-b flex justify-between items-center">
                        <h3 className="font-black text-red-800 text-lg">📕 错题本 ({list.length})</h3>
                        <button onClick={onClose} className="text-2xl">×</button>
                    </div>
                    <div className="flex-1 overflow-y-auto p-4 space-y-4 bg-gray-50">
                        {list.length === 0 ? (
                            <div className="text-center text-gray-400 mt-20">太棒了，没有错题！</div>
                        ) : (
                            list.map((q, i) => (
                                <div key={i} className="bg-white border-l-4 border-red-400 p-4 rounded-xl shadow-sm">
                                    <div className="font-bold text-gray-800 mb-2">{i+1}. {q.t}</div>
                                    <div className="flex flex-col gap-1 bg-red-50 p-2 rounded-lg text-sm">
                                        <div className="text-green-700 font-bold">✅ 正确答案：{q.a}</div>
                                        {/* 下面这一行就是显示解析的关键 */}
                                        <div className="text-gray-600 border-t border-red-100 pt-1 mt-1">
                                            💡 <span className="font-bold">解析：</span>{q.e || "暂无详细解析，请复习对应知识点。"}
                                        </div>
                                    </div>
                                </div>
                            ))
                        )}
                    </div>
                </div>
            </div>
        );

        // --- App 主入口 (逻辑核心) ---
        const App = () => {
            const [view, setView] = useState('LOGIN');
            const [user, setUser] = useState(null);
            const [battleCfg, setBattleCfg] = useState(null);
            const [msgs, setMsgs] = useState([]);
            const [isMusicOn, setIsMusicOn] = useState(false); // 默认关闭，用户点击后开启
            // 弹窗状态
            const [showMail, setShowMail] = useState(false);
            const [showWrong, setShowWrong] = useState(false);
            const [showShop, setShowShop] = useState(false);
            const [showBag, setShowBag] = useState(false);
            const [showPet, setShowPet] = useState(false);
            const [showPK, setShowPK] = useState(false);
            const [showChallenge, setShowChallenge] = useState(false);
            const [showGacha, setShowGacha] = useState(false); 
            const [newRank, setNewRank] = useState(null);
            const [showMapModal, setShowMapModal] = useState(null);
            const [mapCanLoot, setMapCanLoot] = useState(false);

            useEffect(() => {
                try {
                    const saved = JSON.parse(localStorage.getItem('v21_user'));
                    if(saved) { 
                        if(saved.stamina===undefined) saved.stamina=100;
                        if(!saved.pets) saved.pets=[saved.pid];
                        if(saved.tokens===undefined) saved.tokens=0;
                        setUser(saved); setView('DASH'); 
                    }
                    setMsgs(JSON.parse(localStorage.getItem('v21_msgs')||'[]'));
                } catch(e) {}
                const t = setInterval(() => {
                    setUser(u => { if (!u || u.stamina >= 100) return u; const nu={...u, stamina: u.stamina+1}; localStorage.setItem('v21_user', JSON.stringify(nu)); return nu; });
                }, 60000); 
                return () => clearInterval(t);
            }, []);

            const saveUser = (u) => { setUser(u); localStorage.setItem('v21_user', JSON.stringify(u)); };
            const handleRecordWrong = (q) => { 
                // 1. 防御性检查：如果没有题目内容，直接退出
                if (!q || !q.t) {
                    console.warn("尝试记录无效错题:", q);
                    return;
                }

                setUser(prev => { 
                    // 2. 确保 wrong 数组一定存在，即使 prev.wrong 是 undefined
                    const currentWrongList = Array.isArray(prev.wrong) ? prev.wrong : [];
                    
                    // 3. 查重逻辑：检查题目是否已存在（对比题目文字 q.t）
                    const isExist = currentWrongList.some(item => item.t === q.t);

                    if (!isExist) {
                        // 4. 构建新错题对象
                        const newWrongItem = {
                            t: q.t, 
                            a: q.a, 
                            e: q.e || "暂无解析",
                            time: new Date().toLocaleTimeString() // 加个时间戳方便调试
                        };

                        // 5. 合并新状态：新题排在最前面
                        const newUserState = { 
                            ...prev, 
                            wrong: [newWrongItem, ...currentWrongList] 
                        };

                        // 6. 同步写入 LocalStorage (防止刷新丢失)
                        localStorage.setItem('v21_user', JSON.stringify(newUserState));
                        
                        console.log("✅ 已记录错题:", newWrongItem.t); // 控制台日志
                        return newUserState; 
                    } 
                    
                    // 如果已存在，不更新状态
                    return prev; 
                }); 
            };
           const handleLogin = (name, pid) => { 
                SoundSystem.init(); 
                setIsMusicOn(true); // <--- ✅ 登录时自动开启音乐
                saveUser({ name, pid, coins:0, exp:0, wrong:[], inventory:[], stamina: 100, pets: [pid], tokens: 0 }); 
                setView('DASH'); 
            };
            const handleStartBattle = (mid, mode) => { if (user.stamina < 5) { alert("体力不足！"); return; } setBattleCfg({mid, mode}); setView('BATTLE'); };
            
            const handleResult = (win, q) => {
                // 1. 先记录错题（如果是失败的话）
                if (!win) {
                    handleRecordWrong(q);
                }

                // 2. 更新用户状态（金币、经验、体力）
                setUser(prev => {
                    let nu = { ...prev };
                    
                    if (win) {
                        // 胜利逻辑
                        const addExp = battleCfg.mid === 'BOSS' ? 50 : 10;
                        // 简单的段位检查逻辑
                        const getRank = (exp) => RANKS.find((r, i) => exp >= r.minExp && (i === RANKS.length - 1 || exp < RANKS[i+1].minExp)) || RANKS[0];
                        const oldR = getRank(prev.exp);
                        const newR = getRank(prev.exp + addExp);
                        
                        // 升级判断
                        if (newR.minExp > oldR.minExp) { 
                            setTimeout(() => setNewRank(newR), 500); 
                            nu.tokens = (nu.tokens || 0) + 1; 
                        }
                        
                        nu.coins = (nu.coins || 0) + (battleCfg.mid === 'BOSS' ? 50 : 10);
                        nu.exp = (nu.exp || 0) + addExp;
                    } else {
                        // 失败逻辑：扣体力
                        nu.stamina = Math.max(0, (nu.stamina || 0) - 5);
                    }
                    
                    // 保存到本地
                    localStorage.setItem('v21_user', JSON.stringify(nu));
                    return nu;
                });
            };
            const handleBuy = (item) => {
                if (user.coins >= item.price) {
                    const nu = { ...user, coins: user.coins - item.price };
                    if (['item','box','real'].some(k=>item.id.startsWith(k))) nu.inventory = [...(nu.inventory||[]), item.id];
                    saveUser(nu); alert(`购买成功！`);
                } else alert("金币不足！");
            };

            const handleUseItem = (item) => {
                if (item.id === 'item1' || item.id === 'item7') {
                    if (user.stamina >= 100) { alert("体力已满！"); return; }
                    const nu = { ...user, stamina: Math.min(100, user.stamina + 30) };
                    const idx = nu.inventory.indexOf(item.id);
                    if (idx > -1) nu.inventory.splice(idx, 1);
                    saveUser(nu); alert("体力恢复了 30 点！");
                } else alert("这个物品只能收藏哦！");
            };

            const handleGachaDraw = (cost, prize) => {
                let nu = { ...user, coins: user.coins - cost };
                
                // 处理奖励
                if(prize.type === 'exp') nu.exp += prize.val;
                else if(['item','real'].includes(prize.type)) nu.inventory = [...(nu.inventory||[]), prize.id];
                
                // ✅ 保存保底进度 (如果有的话)
                if (prize.newPityCount !== undefined) {
                    nu.pityCount = prize.newPityCount;
                }

                saveUser(nu);
            };
       // 👇 彩蛋逻辑：加金币 + 播放音效
            // 👇 修复后的彩蛋逻辑：防止重复领取
            const handleEasterEgg = () => {
                // 1. 检查是否已经领过
                if (user.hasEgg) {
                    alert("这个彩蛋已经被发现啦！留点金币给其他小朋友吧~");
                    return;
                }

                // 2. 领取奖励并标记
                SoundSystem.play('win'); 
                const nu = { 
                    ...user, 
                    coins: (user.coins || 0) + 800,
                    hasEgg: true // ✅ 标记已领取
                };
                saveUser(nu);
                alert("🎉 恭喜触发隐藏彩蛋！\n💰 获得 800 金币！");
            };
            // 计算当前BGM场景
            let currentScene = 'LOBBY';
            if (view === 'BATTLE' && battleCfg) {
                currentScene = battleCfg.mid === 'BOSS' ? 'BOSS' : 'BATTLE';
            }

            return (
                <div className="max-w-4xl mx-auto min-h-screen shadow-2xl relative overflow-hidden">
                    {/* ✅ 挂载音乐播放器 */}
                    <MusicPlayer scene={currentScene} isMuted={!isMusicOn} />

                    {view === 'LOGIN' && <LoginScreen onLogin={handleLogin} onTeacher={()=>alert("教师后台开发中")} />}
                    {view === 'DASH' && user && (
                        <Dashboard 
                            user={user}
                            onStart={handleStartBattle}
                            onShop={()=>setShowShop(true)}
                            onWrong={()=>setShowWrong(true)}
                            onMsg={()=>setShowMail(true)}
                            onLogout={()=>{setView('LOGIN'); setUser(null);}}
                            onOpenPK={()=>setShowPK(true)}
                            onOpenChallenge={()=>setShowChallenge(true)}
                            onOpenPet={()=>setShowPet(true)}
                            onOpenBag={()=>setShowBag(true)}
                            onOpenGacha={()=>setShowGacha(true)}
                            onEasterEgg={handleEasterEgg} 
                       // 👇 新增这两个传参
                            isMusicOn={isMusicOn}
                            onToggleMusic={() => setIsMusicOn(!isMusicOn)}
                        />
                    )} {/* 记得保留这个闭合括号 */}
                    {view === 'BATTLE' && battleCfg && <Battle mid={battleCfg.mid} mode={battleCfg.mode} user={user} onClose={()=>setView('DASH')} onRes={handleResult} onShowMap={(mid)=>{setShowMapModal(mid); setMapCanLoot(false);}} />}
                    
                    {/* 弹窗层 */}
                    {showShop && <Shop user={user} onClose={()=>setShowShop(false)} onBuy={handleBuy} />}
                    {showGacha && <GachaMachine user={user} onClose={()=>setShowGacha(false)} onDraw={handleGachaDraw} />}
                    {showBag && <Backpack user={user} onClose={()=>setShowBag(false)} onUse={handleUseItem} />}
                    {showPet && <PetCenter user={user} onClose={()=>setShowPet(false)} onSwitch={(pid)=>{saveUser({...user, pid}); alert("更换成功");}} onAdopt={(pid)=>{if(user.tokens>0){saveUser({...user, tokens:user.tokens-1, pets:[...(user.pets||[]), pid]}); alert("领养成功");}}} />}
                    {showPK && <PKBattle user={user} onClose={()=>setShowPK(false)} onWin={(w,d)=>{if(w){const r=d==='HARD'?100:50; saveUser({...user, coins:user.coins+r, exp:user.exp+r}); alert(`PK胜利！+${r}`);} setShowPK(false);}} />}
                    {showChallenge && <ChallengePath onClose={()=>setShowChallenge(false)} onFinish={(s)=>{if(s>=80){saveUser({...user, coins:user.coins+100, exp:user.exp+200, tokens:(user.tokens||0)+1}); alert("挑战成功！奖励已发！");} setShowChallenge(false);}} />}
                    {newRank && <LevelUpModal rank={newRank} onClose={()=>setNewRank(null)} />}
                    {showMapModal && <KnowledgeMap mid={showMapModal} onClose={()=>setShowMapModal(null)} onAddCoin={(n)=>alert(`获得${n}金币`)} canLoot={mapCanLoot} />}
                    {showMail && <Mailbox msgs={msgs} onSend={(txt)=>{const nm=[...msgs,{text:txt, time:new Date().toLocaleTimeString(), isMe:true}]; setMsgs(nm); localStorage.setItem('v21_msgs', JSON.stringify(nm));}} onClose={()=>setShowMail(false)} />}
                    {showWrong && <WrongBook list={user.wrong||[]} onClose={()=>setShowWrong(false)} />}
                </div>
            );
        };

        // --- 智能洗牌逻辑定义 ---
        const SmartMixin = {
            _bags: {},
            get: function(mid, mode, history=[]) {
                if(mid === 'BOSS') {
                    const pool = [...(STATIC_DB.BOSS.APP || []), this.BOSS(this), this.BOSS(this)];
                    return pool[Math.floor(Math.random() * pool.length)];
                }
                const key = mid + '_' + mode;
                if (!this._bags[key] || this._bags[key].length === 0) {
                    const staticList = STATIC_DB[mid]?.[mode] || [];
                    let indices = staticList.map((_, i) => i);
                    const dynCount = Math.max(2, Math.floor(indices.length * 0.4));
                    for(let i=0; i<dynCount; i++) indices.push(-1);
                    for (let i = indices.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [indices[i], indices[j]] = [indices[j], indices[i]];
                    }
                    this._bags[key] = indices;
                }
                const index = this._bags[key].pop();
                let q;
                if (index === -1) {
                    const genFunc = this[mid] || this.M2;
                    q = genFunc(this);
                    if (mode === 'APP') q.type = 'INPUT';
                } else {
                    q = STATIC_DB[mid][mode][index];
                }
                return q;
            }
        };
        Object.assign(Generator, SmartMixin);

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
